# メイン画面（イベント一覧）設計書

## 1. 画面概要

### 1.1 画面名
メイン画面（イベント一覧）

### 1.2 目的
ユーザーが登録したイベントの一覧を表示し、最後に実行してからの経過時間を一目で確認できる画面。アプリケーションのメイン機能となる。

### 1.3 アクセス方法
- アプリケーション起動時のデフォルト画面
- サイドメニューから「ホーム」を選択

### 1.4 URL設計

#### フロントエンドURL
```
ベースURL: https://example.com

メイン画面: /
```

**クエリパラメータ:**
- `sort`: ソート順（`alphabetical` | `date-desc` | `date-asc` | `custom`）
- `timeFilter`: 時間フィルター（`all` | `weeks` | `months` | `years`）
- `category`: カテゴリーフィルター（配列形式で複数指定可能）
  - 単一: `?category=book`
  - 複数: `?category=book&category=star`（同じキーを繰り返し指定）
  - Nuxt3では自動的に配列として扱われます
- `q`: 検索クエリ

**Nuxt3での取得方法:**
```typescript
// pages/index.vue
const route = useRoute();

// 単一の場合: route.query.category = 'book' (string)
// 複数の場合: route.query.category = ['book', 'star'] (string[])
const categories = computed(() => {
  const category = route.query.category;
  if (!category) return [];
  return Array.isArray(category) ? category : [category];
});
```

**URL例:**
```
# デフォルト表示
https://example.com/

# ソート指定
https://example.com/?sort=date-desc

# 時間フィルター適用
https://example.com/?timeFilter=weeks

# カテゴリーフィルター適用（単一）
https://example.com/?category=book

# カテゴリーフィルター適用（複数）
https://example.com/?category=book&category=star

# 検索
https://example.com/?q=エアコン

# 複合条件
https://example.com/?sort=date-desc&timeFilter=months&category=book&category=star&q=掃除
```

#### バックエンドAPI URL
```
ベースURL: https://api.example.com

# イベント一覧取得
GET /events

# イベント詳細取得
GET /events/:id

# イベント作成
POST /events

# イベント更新
PUT /events/:id
PATCH /events/:id

# イベント削除
DELETE /events/:id
```

## 2. 画面構成

### 2.1 レイアウト構成

```
┌─────────────────────────────────────┐
│ ☰  最後はいつ？          � Taro  🔍 │ ← ヘッダー
├─────────────────────────────────────┤
│                                     │
│  ┌───────────────────────────────┐  │
│  │ 📌 イベント名1                │  │
│  │ 2年 3ヶ月 15日                │  │ ← イベントカード
│  │ メモ: 前回のメモ内容          │  │
│  │ 2023/10/01                    │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ 📚 イベント名2                │  │
│  │ 0年 1ヶ月 5日                 │  │
│  │ 2025/12/10                    │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ ⭐ イベント名3                │  │
│  │ 0年 0ヶ月 2日                 │  │
│  │ 2026/01/13                    │  │
│  └───────────────────────────────┘  │
│                                     │
│                         [+]         │ ← 追加ボタン
└─────────────────────────────────────┘
```

### 2.2 UI コンポーネント構成

#### ヘッダー（Header）
- **ハンバーガーメニューアイコン**
  - 位置: 左端
  - アクション: サイドメニューを開く
  
- **タイトル**
  - テキスト: "最後はいつ？"
  - 位置: 中央寄り
  
- **ニックネーム表示**
  - フォーマット: 👤 {nickname}
  - 位置: 検索アイコンの右
  - フォントサイズ: 14px
  - 最大表示文字数: 10文字（超過時は"..."）
  - 例: "👤 Taro"
  
- **検索アイコン**
  - 位置: 右端
  - アクション: 検索バーを表示

#### イベントカード（EventCard）
各カードには以下の情報を表示：

1. **アイコン**
   - サイズ: 24x24px
   - カテゴリー別に色分け
   - 15種類のアイコンから選択可能

2. **イベント名**
   - フォントサイズ: 18px（モバイル）、20px（デスクトップ）
   - フォントウェイト: 600（Semi-Bold）
   - 最大表示行数: 2行
   - 超過時: "..." で省略

3. **経過時間カウンター**
   - 表示形式: "X年 Yヶ月 Z日"
   - フォントサイズ: 24px（モバイル）、28px（デスクトップ）
   - フォントウェイト: 700（Bold）
   - 色: 経過時間に応じて変化
     - 7日以内: グリーン (#10B981)
     - 1ヶ月以内: イエロー (#F59E0B)
     - 1年以内: オレンジ (#F97316)
     - 1年以上: レッド (#EF4444)

4. **サブ情報エリア**
   - 最後に実行した回のメモ（1行表示、省略あり）
   - 最終実行日時（YYYY/MM/DD 形式）
   - フォントサイズ: 14px
   - 色: グレー (#6B7280)

5. **カードスタイル**
   - 背景色: 白 (#FFFFFF) / ダークモード時: (#1F2937)
   - ボーダー: 1px solid (#E5E7EB) / ダークモード時: (#374151)
   - ボーダーラジアス: 12px
   - シャドウ: 0 1px 3px rgba(0, 0, 0, 0.1)
   - パディング: 16px
   - マージン: 12px（上下）

#### フローティングアクションボタン（FAB）
- **位置**: 画面右下固定
- **サイズ**: 56x56px（モバイル）、64x64px（デスクトップ）
- **アイコン**: プラス記号 "+"
- **背景色**: プライマリーカラー (#3B82F6)
- **シャドウ**: 0 4px 6px rgba(0, 0, 0, 0.1)
- **アクション**: イベント作成画面へ遷移

## 3. 機能詳細

### 3.1 イベント一覧表示

#### 表示順序
デフォルトはアルファベット順（設定画面で変更可能）

**ソートオプション（設定画面で選択）:**
1. アルファベット順（デフォルト）
2. 日時降順（最新のイベントが上）
3. 日時昇順（古いイベントが上）

#### 表示内容
- 登録されているすべてのイベント
- 各イベントの経過時間をリアルタイム計算
- フィルター適用時は条件に合致するイベントのみ表示

#### 空の状態（Empty State）
イベントが0件の場合：
```
┌─────────────────────────────────────┐
│                                     │
│           📝                        │
│                                     │
│    イベントがありません              │
│                                     │
│    「+」ボタンから                  │
│    最初のイベントを追加しましょう    │
│                                     │
│                         [+]         │
└─────────────────────────────────────┘
```

### 3.2 検索機能

#### 検索バーの表示
- 検索アイコンタップ時にアニメーションで表示
- ヘッダーに検索バーが展開

#### 検索仕様
- **検索対象**:
  - イベント名
  - メモ内容
  
- **検索方式**:
  - 部分一致検索
  - リアルタイム検索（入力に応じて即座にフィルタリング）
  - 大文字小文字を区別しない
  
- **検索バーUI**:
  - プレースホルダー: "イベントを検索..."
  - クリアボタン: 入力がある場合に表示
  - キャンセルボタン: 検索バーを閉じる

### 3.3 経過時間計算

#### 計算ロジック
```typescript
interface TimeElapsed {
  years: number;
  months: number;
  days: number;
  hours?: number;
  minutes?: number;
  seconds?: number;
}

/**
 * 経過時間を計算する
 * @param lastEventDate 最後のイベント実行日時
 * @param currentDate 現在日時
 * @param useTimeFlipperWithin24Hours 24時間以内の場合に時分秒を使用するか
 * @returns 経過時間オブジェクト
 */
function calculateElapsedTime(
  lastEventDate: Date,
  currentDate: Date,
  useTimeFlipperWithin24Hours: boolean
): TimeElapsed
```

#### 表示形式
1. **通常表示（24時間経過後）**
   - 形式: "X年 Yヶ月 Z日"
   - 例: "2年 3ヶ月 15日"

2. **タイムフリッパー表示（24時間以内、設定で有効な場合）**
   - 形式: "X時間 Y分 Z秒"
   - 例: "12時間 34分 56秒"
   - アニメーション: 秒数がフリップアニメーションで更新

#### 更新頻度
- タイムフリッパー有効時（24時間以内）: 1秒ごと
- 通常表示: 1分ごと（パフォーマンス最適化）

#### 日時計算ルール（設定による）
- **真夜中を起点とする（デフォルト）**: 
  - 午前0時を日付の切り替わりとする
  - 例: 1/15 23:59 → 1/16 00:00 で1日経過

### 3.4 インタラクション

#### イベントカードのタップ
- **アクション**: イベント履歴画面へ遷移
- **アニメーション**: タップ時に軽い拡大アニメーション（scale: 0.98）
- **遷移パターン**: 右からスライドイン

#### スクロール
- **スクロール方向**: 縦方向
- **オーバースクロール**: バウンス効果（iOS風）
- **スクロール時のヘッダー**: 固定表示

#### プルトゥリフレッシュ
- 画面を下に引っ張ることでデータを再読み込み
- ローディングインジケーター表示

### 3.5 フィルター機能

#### フィルター適用時の表示
ヘッダー下部にフィルター適用中を示すチップを表示

```
┌─────────────────────────────────────┐
│ ☰  最後はいつ？          🔍        │
│ 📌 数週間前 × 📚本 ×                │ ← フィルターチップ
├─────────────────────────────────────┤
```

#### フィルター解除
- 各チップの「×」をタップで個別解除
- サイドメニューから全解除

## 4. 状態管理

### 4.1 コンポーネント状態

```typescript
interface MainScreenState {
  // イベント一覧
  events: Event[];
  
  // フィルター・検索
  searchQuery: string;
  activeFilters: {
    timeFilters: TimeFilterType[];
    categoryFilters: CategoryType[];
  };
  
  // UI状態
  isSearchVisible: boolean;
  isSideMenuOpen: boolean;
  isLoading: boolean;
  
  // ソート設定
  sortType: SortType;
}

interface Event {
  id: string;
  name: string;
  categoryIcon: IconType;
  lastExecutedHistoryId: string | null;
  lastExecutedAt: Date | null;   // 履歴から取得
  lastExecutedMemo?: string;
  createdAt: Date;
  updatedAt: Date;
}

type SortType = 'alphabetical' | 'dateDesc' | 'dateAsc' | 'custom';
type TimeFilterType = 'all' | 'weeks' | 'months' | 'years';
type CategoryType = 'pin' | 'book' | 'folder' | 'star' | 'graph' | 'sun' | 'person' | 'hospital' | 'plus' | 'leaf' | 'search' | 'people' | 'snow' | 'fire' | 'lightning';
```

### 4.2 データフロー

```
[API] GET /events (全件取得)
         ↓
    [Pinia Store] (全イベントを保持)
         ↓
   [Computed Properties] (フィルター・ソート・検索をフロント側で実行)
         ↓
   [Main Screen Component] (フィルター済みイベントを表示)
         ↓
    [Event Card Components]
```

**処理方針:**
- APIからは認証ユーザーの全イベントを一度に取得（ページネーションなし）
- フィルター・ソート・検索はすべてフロント側で実行
- URLクエリパラメータは画面状態の保持・共有のために使用
- イベント数が増えた場合（目安: 1000件以上）は、サーバー側でのフィルタリングを検討

## 5. API仕様（Phase 1）

### 5.1 イベント一覧取得

#### エンドポイント
```
GET /events
```

#### リクエストパラメータ
なし（認証ユーザーの全イベントを取得）

#### リクエスト例
```bash
# 全イベント取得
GET /events
```

**注意事項:**
- フィルター、ソート、検索のパラメータは**不要**です
- これらの処理はすべてフロント側で実行します
- URLクエリパラメータ（`?sort=date-desc&timeFilter=weeks`など）は画面の状態管理用であり、APIには送信しません

#### レスポンス

**成功時（200 OK）:**
```typescript
interface GetEventsResponse {
  success: true;
  data: {
    events: Event[];
  };
}

interface Event {
  id: string;
  name: string;
  categoryIcon: CategoryType;
  lastExecutedHistoryId: string | null;
  lastExecutedAt: string | null; // ISO 8601形式（例: "2026-01-15T23:31:00Z"）
  lastExecutedMemo?: string;
  createdAt: string;           // ISO 8601形式
  updatedAt: string;           // ISO 8601形式
}
```

**レスポンス例:**
```json
{
  "success": true,
  "data": {
    "events": [
      {
        "id": "evt_1234567890",
        "name": "エアコンフィルター掃除",
        "categoryIcon": "leaf",
        "lastExecutedHistoryId": "hist_1234567890",
        "lastExecutedAt": "2023-10-01T10:00:00Z",
        "lastExecutedMemo": "フィルターを水洗いした",
        "createdAt": "2023-01-01T00:00:00Z",
        "updatedAt": "2023-10-01T10:00:00Z"
      },
      {
        "id": "evt_0987654321",
        "name": "本を読む",
        "categoryIcon": "book",
        "lastExecutedHistoryId": "hist_0987654321",
        "lastExecutedAt": "2025-12-10T14:30:00Z",
        "lastExecutedMemo": null,
        "createdAt": "2024-06-15T08:00:00Z",
        "updatedAt": "2025-12-10T14:30:00Z"
      },
      {
        "id": "evt_1111111111",
        "name": "植物に水やり",
        "categoryIcon": "leaf",
        "lastExecutedHistoryId": "hist_1111111111",
        "lastExecutedAt": "2026-01-13T09:00:00Z",
        "lastExecutedMemo": null,
        "createdAt": "2025-06-01T00:00:00Z",
        "updatedAt": "2026-01-13T09:00:00Z"
      }
    ]
  }
}
```

**エラー時:**
```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;           // エラーコード
    message: string;        // エラーメッセージ
    details?: any;          // 詳細情報（任意）
  };
}
```

**エラーレスポンス例:**
```json
// 401 Unauthorized - 認証エラー
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Authentication required"
  }
}

// 500 Internal Server Error - サーバーエラー
{
  "success": false,
  "error": {
    "code": "INTERNAL_SERVER_ERROR",
    "message": "An unexpected error occurred"
  }
}
```

#### ステータスコード

| コード | 説明 |
|-------|------|
| 200 | 成功 |
| 401 | 認証が必要 |
| 403 | アクセス権限がない |
| 500 | サーバー内部エラー |
| 503 | サービス利用不可（メンテナンス中など） |

## 6. パフォーマンス最適化

### 6.1 仮想スクロール
- イベント数が50件を超える場合、仮想スクロールを実装
- 表示領域外のコンポーネントは DOM から削除

## 7. レスポンシブデザイン

### 7.1 ブレークポイント

```typescript
const breakpoints = {
  mobile: '0px - 640px',
  tablet: '641px - 1024px',
  desktop: '1025px以上'
};
```

### 7.2 各デバイスでのレイアウト

#### モバイル（0px - 640px）
- イベントカード: 1カラム
- パディング: 16px
- カードの高さ: 自動（最小120px）

#### タブレット（641px - 1024px）
- イベントカード: 2カラム（グリッドレイアウト）
- パディング: 24px
- カードの高さ: 自動（最小140px）

#### デスクトップ（1025px以上）
- イベントカード: 3カラム（グリッドレイアウト）
- 最大幅: 1280px（中央配置）
- パディング: 32px
- カードの高さ: 自動（最小160px）

## 8. アクセシビリティ

### 8.1 キーボード操作
- Tab キー: フォーカス移動
- Enter / Space キー: カード選択
- Esc キー: 検索バーを閉じる


### 8.2 コントラスト比
- WCAG 2.1 レベル AA 準拠
- テキストと背景のコントラスト比: 最低 4.5:1

## 9. エラーハンドリング

### 9.1 データ読み込みエラー
```
┌─────────────────────────────────────┐
│                                     │
│           ⚠️                        │
│                                     │
│    データの読み込みに失敗しました    │
│                                     │
│         [再試行]                    │
│                                     │
└─────────────────────────────────────┘
```

## 10. テストケース

### 10.1 表示テスト
- [ ] イベントが0件の場合、Empty State が表示される
- [ ] イベントが複数件ある場合、設定されたソート順で表示される
- [ ] 経過時間が正しく計算・表示される
- [ ] 経過時間の色が適切に変化する

### 10.2 インタラクションテスト
- [ ] イベントカードをタップすると履歴画面に遷移する
- [ ] FAB をタップすると作成画面に遷移する
- [ ] ハンバーガーメニューをタップするとサイドメニューが開く
- [ ] 検索アイコンをタップすると検索バーが表示される

### 10.3 検索機能テスト
- [ ] イベント名で検索できる
- [ ] メモ内容で検索できる
- [ ] リアルタイムで検索結果が更新される
- [ ] 検索結果が0件の場合、適切なメッセージが表示される

### 10.4 フィルターテスト
- [ ] 時間フィルターが正しく適用される
- [ ] カテゴリーフィルターが正しく適用される
- [ ] 複数フィルターの組み合わせが正しく動作する
- [ ] フィルター適用中にチップが表示される

### 10.5 パフォーマンステスト
- [ ] 100件のイベントでもスムーズにスクロールできる
- [ ] 経過時間の更新が1秒以内に完了する
- [ ] 検索のレスポンスが200ms以内

### 10.6 レスポンシブテスト
- [ ] モバイル表示が適切にレイアウトされる
- [ ] タブレット表示が適切にレイアウトされる
- [ ] デスクトップ表示が適切にレイアウトされる

## 11. 実装優先順位（Phase 1 MVP）

### 優先度: 高
1. イベント一覧の表示
2. 経過時間の計算・表示
3. イベントカードのタップ → 履歴画面遷移
4. FAB → イベント作成画面遷移
5. データの永続化（データベース）

### 優先度: 中
6. ソート機能（アルファベット順、日時降順/昇順）
7. 空の状態（Empty State）表示
8. ローディング状態の表示

### 優先度: 低（Phase 2以降）
9. 検索機能
10. フィルター機能
11. プルトゥリフレッシュ
12. タイムフリッパー（24時間以内の時分秒表示）

## 12. 技術的な実装メモ

### 12.1 コンポーネント構成（Vue 3 / Nuxt 3）

```
pages/
  index.vue                 # メイン画面
    
components/
  MainScreen/
    EventCard.vue          # イベントカード
    EventList.vue          # イベント一覧
    SearchBar.vue          # 検索バー
    EmptyState.vue         # 空の状態
    FilterChips.vue        # フィルターチップ
```

### 12.2 使用するライブラリ
- **日時計算**: dayjs または date-fns
- **アニメーション**: Nuxt UI v4 の組み込み機能 + Framer Motion（必要に応じて）
- **アイコン**: Nuxt UI Icons または Heroicons
- **状態管理**: Pinia

### 12.3 Nuxt UI v4 コンポーネント活用
- `<UButton>`: FAB、検索ボタン
- `<UCard>`: イベントカード
- `<UInput>`: 検索バー
- `<UIcon>`: アイコン全般
- `<UBadge>`: フィルターチップ
- `<UEmpty>`: Empty State

## 13. 今後の拡張性

### Phase 2以降で追加予定
- イベントカードの左スワイプ削除機能
- イベントのカスタムソート順（ドラッグ&ドロップ）
- プルトゥリフレッシュによる同期
- オフライン対応の強化

---

**作成日**: 2026/01/16  
**バージョン**: 1.0  
**更新履歴**:
- 2026/01/16: 初版作成
