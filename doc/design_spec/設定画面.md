# 設定画面設計書

## 1. 画面概要

### 1.1 画面名
設定画面

### 1.2 目的
アプリケーションの全体的な動作や表示方法をカスタマイズするための設定画面。データエクスポート、ソート順、時間表示オプション、リマインダーなどの設定を管理する。

### 1.3 アクセス方法
- サイドメニューの「設定」ボタンをタップ
- URL: `/settings`

### 1.4 URL設計

#### フロントエンドURL
```
ベースURL: https://example.com

# 設定画面
/settings
```

#### バックエンドAPI URL
```
ベースURL: https://api.example.com

# ユーザー設定取得
GET /settings

# ユーザー設定更新
PUT /settings
PATCH /settings

# データエクスポート
GET /export/csv
```

## 2. 画面構成

### 2.1 レイアウト構成

```
┌─────────────────────────────────────┐
│ ←  設定                             │ ← ヘッダー
├─────────────────────────────────────┤
│                                     │
│  データ                              │ ← セクション1
│  ┌─────────────────────────────┐   │
│  │  CSVとしてエクスポート  →   │   │
│  └─────────────────────────────┘   │
│                                     │
│  表示設定                            │ ← セクション2
│  ┌─────────────────────────────┐   │
│  │  ソート順              →   │   │
│  │  アルファベット順           │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  時間設定              →   │   │
│  │  真夜中を起点とする         │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  タイムフリッパー      ○   │   │
│  │  24時間以内は時分秒で表示   │   │
│  └─────────────────────────────┘   │
│                                     │
│  通知                                │ ← セクション3
│  ┌─────────────────────────────┐   │
│  │  リマインダー          →   │   │
│  └─────────────────────────────┘   │
│                                     │
│  その他                              │ ← セクション4
│  ┌─────────────────────────────┐   │
│  │  チュートリアル        ○   │   │
│  └─────────────────────────────┘   │
│                                     │
│  アプリ情報                          │ ← セクション5
│  ┌─────────────────────────────┐   │
│  │  バージョン                 │   │
│  │  1.0.0                     │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  利用規約              →   │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  プライバシーポリシー   →   │   │
│  └─────────────────────────────┘   │
│                                     │
└─────────────────────────────────────┘
```

### 2.2 UI コンポーネント構成

#### ヘッダー（Header）

**左側: 戻るボタン**
- アイコン: ← (矢印)
- アクション: 前の画面に戻る
- 位置: 左端

**中央: タイトル**
- テキスト: "設定"
- フォントサイズ: 18px（モバイル）、20px（デスクトップ）
- フォントウェイト: 600（Semi-Bold）

#### セクションヘッダー

**スタイル:**
- フォントサイズ: 12px
- フォントウェイト: 600（Semi-Bold）
- 色: グレー (#6B7280)
- 大文字: YES（ALL CAPS）
- パディング: 16px（上）、20px（左右）、8px（下）
- 背景色: グレー薄め (#F9FAFB)

#### 設定項目カード

**基本スタイル:**
- パディング: 16px（上下）、20px（左右）
- 背景色: 白 (#FFFFFF)
- ボーダー下部: 1px solid #E5E7EB
- ホバー時: 背景色 #F9FAFB

**構造:**
```
┌─────────────────────────────┐
│  主ラベル              →   │
│  副ラベル（あれば）         │
└─────────────────────────────┘
```

**主ラベル:**
- フォントサイズ: 16px
- フォントウェイト: 500（Medium）
- 色: ダークグレー (#1F2937)

**副ラベル:**
- フォントサイズ: 14px
- フォントウェイト: 400（Regular）
- 色: グレー (#6B7280)
- マージン上: 4px

**右側のインジケーター:**
- **矢印 (→)**: 次の画面へ遷移
  - アイコン: chevron-right
  - サイズ: 20x20px
  - 色: グレー (#9CA3AF)
  
- **トグルスイッチ (○)**: ON/OFF切り替え
  - サイズ: 44x24px
  - ON: プライマリーカラー (#3B82F6)
  - OFF: グレー (#D1D5DB)

- **現在値表示**: 選択中の値を表示
  - フォントサイズ: 14px
  - 色: グレー (#6B7280)

## 3. 設定項目詳細

### 3.1 データセクション

#### CSVとしてエクスポート

**説明:**
全イベントと履歴データをCSV形式でエクスポートする

**表示:**
```
┌─────────────────────────────┐
│  CSVとしてエクスポート  →   │
└─────────────────────────────┘
```

**アクション:**
タップでエクスポート確認ダイアログを表示

**ダイアログ:**
```
┌─────────────────────────────────────┐
│                                     │
│  データをエクスポートしますか？      │
│                                     │
│  すべてのイベントと履歴データが      │
│  CSV形式でダウンロードされます。    │
│                                     │
│  ┌─────────┐  ┌─────────┐          │
│  │キャンセル│  │エクスポート│         │
│  └─────────┘  └─────────┘          │
│                                     │
└─────────────────────────────────────┘
```

**エクスポート処理:**
1. API呼び出し: `GET /export/csv`
2. CSVファイルをダウンロード
3. ファイル名: `when-is-the-last-time_YYYYMMDD_HHmmss.csv`
4. トースト通知: "データをエクスポートしました"

**CSV形式:**
```csv
イベントID,イベント名,カテゴリーアイコン,作成日時,最終実行日時,履歴ID,履歴実行日時,履歴メモ
evt_001,エアコンフィルター掃除,leaf,2023-10-15T14:00:00Z,2026-01-15T23:31:00Z,hist_001,2026-01-15T23:31:00Z,フィルターを水洗いした
evt_001,エアコンフィルター掃除,leaf,2023-10-15T14:00:00Z,2026-01-15T23:31:00Z,hist_002,2023-10-01T10:00:00Z,前回の掃除
evt_002,運転免許更新,folder,2023-10-15T14:00:00Z,2023-10-15T14:00:00Z,hist_003,2023-10-15T14:00:00Z,初回記録
```

### 3.2 表示設定セクション

#### ソート順

**説明:**
メイン画面のイベント一覧の並び順を設定

**表示:**
```
┌─────────────────────────────┐
│  ソート順              →   │
│  アルファベット順           │
└─────────────────────────────┘
```

**タップ時:**
ソート順選択画面へ遷移（`/settings/sort`）

**選択肢:**
```
┌─────────────────────────────────────┐
│ ←  ソート順                         │
├─────────────────────────────────────┤
│                                     │
│  ○  アルファベット順                │ ← デフォルト
│  ○  日時降順（最新が上）            │
│  ○  日時昇順（古いものが上）        │
│  ○  カスタム（Phase 2以降）         │
│                                     │
└─────────────────────────────────────┘
```

**動作:**
- 選択すると即座に適用
- 前の画面に自動で戻る
- メイン画面のイベント一覧が新しいソート順で表示される

**データ型:**
```typescript
type SortOrder = 
  | 'alphabetical'  // アルファベット順
  | 'date_desc'     // 日時降順
  | 'date_asc'      // 日時昇順
  | 'custom';       // カスタム（Phase 2以降）
```

#### 時間設定

**説明:**
日付の切り替わりタイミングを設定

**表示:**
```
┌─────────────────────────────┐
│  時間設定              →   │
│  真夜中を起点とする         │
└─────────────────────────────┘
```

**タップ時:**
時間設定選択画面へ遷移（`/settings/time`）

**選択肢:**
```
┌─────────────────────────────────────┐
│ ←  時間設定                         │
├─────────────────────────────────────┤
│                                     │
│  ○  真夜中を起点とする              │ ← デフォルト
│      （午前0時に日付が変わる）      │
│                                     │
│  ○  24時間ごと（Phase 2以降）       │
│      （記録時刻から24時間後）       │
│                                     │
└─────────────────────────────────────┘
```

**動作:**
- 選択すると即座に適用
- 前の画面に自動で戻る
- 経過時間の計算ロジックが変更される

**計算ロジック:**

**真夜中を起点とする:**
```typescript
const calculateElapsedDays = (lastExecutedAt: string): number => {
  const now = dayjs();
  const lastDate = dayjs(lastExecutedAt);
  
  // 午前0時を基準に日数を計算
  const todayStart = now.startOf('day');
  const lastDateStart = lastDate.startOf('day');
  
  return todayStart.diff(lastDateStart, 'day');
};
```

**24時間ごと（Phase 2以降）:**
```typescript
const calculateElapsedDays = (lastExecutedAt: string): number => {
  const now = dayjs();
  const lastDate = dayjs(lastExecutedAt);
  
  // 正確な時刻差で計算
  const hours = now.diff(lastDate, 'hour');
  return Math.floor(hours / 24);
};
```

**データ型:**
```typescript
type TimeOrigin = 
  | 'midnight'  // 真夜中を起点とする
  | '24hours';  // 24時間ごと（Phase 2以降）
```

#### タイムフリッパー

**説明:**
24時間以内のイベントを時・分・秒で表示する

**表示:**
```
┌─────────────────────────────┐
│  タイムフリッパー      ○   │
│  24時間以内は時分秒で表示   │
└─────────────────────────────┘
```

**トグルスイッチ:**
- ON: 24時間以内のイベントを「23時間45分30秒」のように表示
- OFF: 「0日」と表示（デフォルト）

**ON時の表示例:**
```
┌──────────────────────────────────┐
│  🍃  エアコンフィルター掃除       │
│                                  │
│  23時間 45分 30秒                │
│                                  │
│  フィルターを水洗いした           │
│  2026/01/15 23:31               │
└──────────────────────────────────┘
```

**OFF時の表示例:**
```
┌──────────────────────────────────┐
│  🍃  エアコンフィルター掃除       │
│                                  │
│  0日                             │
│                                  │
│  フィルターを水洗いした           │
│  2026/01/15 23:31               │
└──────────────────────────────────┘
```

**実装ロジック:**
```typescript
const formatElapsedTime = (
  lastExecutedAt: string,
  useTimeFlipper: boolean
): string => {
  const now = dayjs();
  const lastDate = dayjs(lastExecutedAt);
  const diffInHours = now.diff(lastDate, 'hour');
  
  if (useTimeFlipper && diffInHours < 24) {
    const hours = now.diff(lastDate, 'hour');
    const minutes = now.diff(lastDate, 'minute') % 60;
    const seconds = now.diff(lastDate, 'second') % 60;
    
    return `${hours}時間 ${minutes}分 ${seconds}秒`;
  } else {
    const days = calculateElapsedDays(lastExecutedAt);
    return `${days}日`;
  }
};
```

**データ型:**
```typescript
interface Settings {
  useTimeFlipper: boolean;  // タイムフリッパーを使用
}
```

### 3.3 通知セクション

#### リマインダー

**説明:**
定期的なリマインダー通知を設定

**表示:**
```
┌─────────────────────────────┐
│  リマインダー          →   │
└─────────────────────────────┘
```

**タップ時:**
リマインダー設定画面へ遷移（`/settings/reminder`）

**リマインダー設定画面:**
```
┌─────────────────────────────────────┐
│ ←  リマインダー                     │
├─────────────────────────────────────┤
│                                     │
│  リマインダーを有効にする  ○       │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  通知タイミング                      │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  毎日              →       │   │
│  │  午前9:00                  │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  通知対象イベント  →       │   │
│  │  1週間以上前のイベント      │   │
│  └─────────────────────────────┘   │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  プレビュー                          │
│                                     │
│  📱  エアコンフィルター掃除          │
│      最後から2年3ヶ月経過しています  │
│                                     │
└─────────────────────────────────────┘
```

**設定項目:**

1. **リマインダーを有効にする**
   - トグルスイッチ
   - ON/OFF

2. **通知タイミング**
   - 選択肢:
     - 毎日（時刻指定）
     - 週1回（曜日・時刻指定）
     - 月1回（日付・時刻指定）
   - デフォルト: 毎日 午前9:00

3. **通知対象イベント**
   - 選択肢:
     - すべてのイベント
     - 1週間以上前のイベント
     - 1ヶ月以上前のイベント
     - 1年以上前のイベント
   - デフォルト: 1週間以上前のイベント

**データ型:**
```typescript
interface ReminderSettings {
  enabled: boolean;
  timing: {
    type: 'daily' | 'weekly' | 'monthly';
    time: string;      // HH:mm形式
    dayOfWeek?: number; // 0-6（週1回の場合）
    dayOfMonth?: number; // 1-31（月1回の場合）
  };
  targetEvents: 'all' | 'week' | 'month' | 'year';
}
```

**通知例:**
```
📱 通知

最後はいつ？
━━━━━━━━━━━━━━━━━━━━━━━━━

🍃 エアコンフィルター掃除
最後から2年3ヶ月経過しています

📁 運転免許更新
最後から2年3ヶ月経過しています

🔥 ガスコンロ掃除
最後から1年2ヶ月経過しています
```

**Phase 1 MVP での実装:**
- Phase 1では設定画面は表示するが、実際の通知機能はPhase 4以降で実装
- 設定は保存されるが通知は送信されない
- 設定画面に「※この機能は準備中です」と表示

### 3.4 その他セクション

#### チュートリアル

**説明:**
初回起動時のチュートリアルを再表示

**表示:**
```
┌─────────────────────────────┐
│  チュートリアル        ○   │
└─────────────────────────────┘
```

**トグルスイッチ:**
- ON: 次回アプリ起動時にチュートリアルを表示
- OFF: チュートリアルを表示しない（デフォルト）

**動作:**
- ONにすると「次回起動時にチュートリアルが表示されます」とトースト通知
- 次回アプリ起動時にチュートリアル画面を表示
- チュートリアル完了後に自動でOFFに戻る

**データ型:**
```typescript
interface Settings {
  showTutorial: boolean;  // チュートリアルを表示
}
```

**Phase 1 MVP での実装:**
- Phase 1ではトグル表示のみ
- 実際のチュートリアル機能はPhase 2以降で実装

### 3.5 アプリ情報セクション

#### バージョン

**説明:**
アプリのバージョン情報を表示

**表示:**
```
┌─────────────────────────────┐
│  バージョン                 │
│  1.0.0                     │
└─────────────────────────────┘
```

**スタイル:**
- タップ不可（静的表示）
- 主ラベル: "バージョン"
- 副ラベル: バージョン番号（例: "1.0.0"）
- 右側インジケーター: なし

**バージョン番号取得:**
```typescript
// package.jsonから取得
const version = computed(() => {
  return runtimeConfig.public.appVersion || '1.0.0';
});
```

#### 利用規約

**説明:**
アプリの利用規約ページへ遷移

**表示:**
```
┌─────────────────────────────┐
│  利用規約              →   │
└─────────────────────────────┘
```

**アクション:**
- タップで利用規約ページへ遷移（`/terms`）
- 別画面で表示

#### プライバシーポリシー

**説明:**
プライバシーポリシーページへ遷移

**表示:**
```
┌─────────────────────────────┐
│  プライバシーポリシー   →   │
└─────────────────────────────┘
```

**アクション:**
- タップでプライバシーポリシーページへ遷移（`/privacy`）
- 別画面で表示

## 4. 状態管理

### 4.1 設定データ構造

#### ローカルストレージ管理の設定

以下の設定はローカルストレージで管理します（サーバーに保存しない）：

```typescript
// ローカルストレージキー: 'when-is-the-last-time:local-settings'
interface LocalSettings {
  // 表示設定
  display: {
    sortOrder: SortOrder;
    timeOrigin: TimeOrigin;
    useTimeFlipper: boolean;
  };
}

// ソート順
type SortOrder = 
  | 'alphabetical'  // アルファベット順
  | 'date_desc'     // 日時降順
  | 'date_asc'      // 日時昇順
  | 'custom';       // カスタム

// 時間起点
type TimeOrigin = 
  | 'midnight'  // 真夜中を起点とする
  | '24hours';  // 24時間ごと

// 初期値（ローカルストレージに設定がない場合）
const DEFAULT_LOCAL_SETTINGS: LocalSettings = {
  display: {
    sortOrder: 'alphabetical',      // デフォルト: アルファベット順
    timeOrigin: 'midnight',         // デフォルト: 真夜中を起点とする
    useTimeFlipper: false,          // デフォルト: OFF（日数表示）
  },
};
```

#### サーバー管理の設定

以下の設定はサーバー（API）で管理します（ユーザーアカウントに紐づく）：

```typescript
interface ServerSettings {
  // データ
  export: {
    lastExportedAt?: string;
  };
  
  // 通知
  notification: {
    reminder: ReminderSettings;
  };
  
  // その他
  misc: {
    showTutorial: boolean;
  };
}

// リマインダー設定
interface ReminderSettings {
  enabled: boolean;
  timing: {
    type: 'daily' | 'weekly' | 'monthly';
    time: string;
    dayOfWeek?: number;
    dayOfMonth?: number;
  };
  targetEvents: 'all' | 'week' | 'month' | 'year';
}

// 初期値（サーバーに設定がない場合）
const DEFAULT_SERVER_SETTINGS: ServerSettings = {
  export: {},
  notification: {
    reminder: {
      enabled: false,                 // デフォルト: OFF
      timing: {
        type: 'daily',
        time: '09:00',                // デフォルト: 毎日午前9時
      },
      targetEvents: 'week',           // デフォルト: 1週間以上前のイベント
    },
  },
  misc: {
    showTutorial: false,              // デフォルト: OFF
  },
};
```

### 4.2 Pinia Store

```typescript
// stores/settings.ts
const LOCAL_STORAGE_KEY = 'when-is-the-last-time:local-settings';

export const useSettingsStore = defineStore('settings', () => {
  // ローカル設定（ローカルストレージ管理）
  const localSettings = ref<LocalSettings>(DEFAULT_LOCAL_SETTINGS);
  
  // サーバー設定（API管理）
  const serverSettings = ref<ServerSettings>(DEFAULT_SERVER_SETTINGS);
  
  // ローカル設定を読み込み
  const loadLocalSettings = () => {
    if (process.client) {
      try {
        const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          localSettings.value = {
            ...DEFAULT_LOCAL_SETTINGS,
            ...parsed,
          };
        }
      } catch (error) {
        console.error('Failed to load local settings:', error);
        // エラー時はデフォルト値を使用
        localSettings.value = DEFAULT_LOCAL_SETTINGS;
      }
    }
  };
  
  // ローカル設定を保存
  const saveLocalSettings = () => {
    if (process.client) {
      try {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localSettings.value));
      } catch (error) {
        console.error('Failed to save local settings:', error);
      }
    }
  };
  
  // サーバー設定を読み込み
  const loadServerSettings = async () => {
    try {
      const response = await $fetch('/settings');
      serverSettings.value = {
        ...DEFAULT_SERVER_SETTINGS,
        ...response.data.settings,
      };
    } catch (error) {
      console.error('Failed to load server settings:', error);
      // エラー時はデフォルト値を使用
      serverSettings.value = DEFAULT_SERVER_SETTINGS;
    }
  };
  
  // サーバー設定を更新
  const updateServerSettings = async (updates: Partial<ServerSettings>) => {
    try {
      const response = await $fetch('/settings', {
        method: 'PATCH',
        body: updates,
      });
      serverSettings.value = response.data.settings;
      return true;
    } catch (error) {
      console.error('Failed to update server settings:', error);
      return false;
    }
  };
  
  // すべての設定を読み込み
  const loadAllSettings = async () => {
    loadLocalSettings();
    await loadServerSettings();
  };
  
  // ===== ローカル設定の更新ヘルパー =====
  
  // ソート順を更新
  const updateSortOrder = (sortOrder: SortOrder) => {
    localSettings.value.display.sortOrder = sortOrder;
    saveLocalSettings();
  };
  
  // 時間設定を更新
  const updateTimeOrigin = (timeOrigin: TimeOrigin) => {
    localSettings.value.display.timeOrigin = timeOrigin;
    saveLocalSettings();
  };
  
  // タイムフリッパーを切り替え
  const toggleTimeFlipper = () => {
    localSettings.value.display.useTimeFlipper = !localSettings.value.display.useTimeFlipper;
    saveLocalSettings();
  };
  
  // ===== サーバー設定の更新ヘルパー =====
  
  // チュートリアルを切り替え
  const toggleTutorial = () => {
    const newValue = !serverSettings.value.misc.showTutorial;
    return updateServerSettings({
      misc: {
        showTutorial: newValue,
      },
    });
  };
  
  // リマインダー設定を更新
  const updateReminderSettings = (reminder: ReminderSettings) => {
    return updateServerSettings({
      notification: {
        reminder,
      },
    });
  };
  
  return {
    // 状態
    localSettings: readonly(localSettings),
    serverSettings: readonly(serverSettings),
    
    // アクション
    loadAllSettings,
    loadLocalSettings,
    loadServerSettings,
    updateSortOrder,
    updateTimeOrigin,
    toggleTimeFlipper,
    toggleTutorial,
    updateReminderSettings,
  };
});
```

## 5. API仕様

**注意:** ソート順、時間設定、タイムフリッパーはローカルストレージで管理するため、以下のAPIには含まれません。

### 5.1 設定取得

#### エンドポイント
```
GET /settings
```

#### リクエスト例
```bash
GET /settings
```

#### レスポンス

**成功時（200 OK）:**
```typescript
interface GetSettingsResponse {
  success: true;
  data: {
    settings: ServerSettings;
  };
}
```

**レスポンス例:**
```json
{
  "success": true,
  "data": {
    "settings": {
      "export": {
        "lastExportedAt": "2026-01-15T10:00:00Z"
      },
      "notification": {
        "reminder": {
          "enabled": false,
          "timing": {
            "type": "daily",
            "time": "09:00"
          },
          "targetEvents": "week"
        }
      },
      "misc": {
        "showTutorial": false
      }
    }
  }
}
```

#### ステータスコード

| コード | 説明 |
|-------|------|
| 200 | 成功 |
| 401 | 認証が必要 |
| 500 | サーバー内部エラー |

### 5.2 設定更新

#### エンドポイント
```
PATCH /settings
```

#### リクエストボディ
```typescript
interface UpdateSettingsRequest {
  export?: {
    lastExportedAt?: string;
  };
  notification?: {
    reminder?: ReminderSettings;
  };
  misc?: {
    showTutorial?: boolean;
  };
}
```

**注意:** `display` 設定（ソート順、時間設定、タイムフリッパー）はローカルストレージで管理するため、このAPIでは更新できません。

#### リクエスト例
```json
PATCH /settings

{
  "misc": {
    "showTutorial": true
  }
}
```

#### レスポンス

**成功時（200 OK）:**
```typescript
interface UpdateSettingsResponse {
  success: true;
  data: {
    settings: ServerSettings;
  };
}
```

**レスポンス例:**
```json
{
  "success": true,
  "data": {
    "settings": {
      "export": {},
      "notification": {
        "reminder": {
          "enabled": false,
          "timing": {
            "type": "daily",
            "time": "09:00"
          },
          "targetEvents": "week"
        }
      },
      "misc": {
        "showTutorial": true
      }
    }
  }
}
```

#### ステータスコード

| コード | 説明 |
|-------|------|
| 200 | 更新成功 |
| 400 | バリデーションエラー |
| 401 | 認証が必要 |
| 500 | サーバー内部エラー |

### 5.3 CSVエクスポート

#### エンドポイント
```
GET /export/csv
```

#### リクエスト例
```bash
GET /export/csv
```

#### レスポンス

**成功時（200 OK）:**
- Content-Type: `text/csv; charset=utf-8`
- Content-Disposition: `attachment; filename="when-is-the-last-time_20260116_123456.csv"`

**CSVフォーマット:**
```csv
イベントID,イベント名,カテゴリーアイコン,作成日時,最終実行日時,履歴ID,履歴実行日時,履歴メモ
evt_001,エアコンフィルター掃除,leaf,2023-10-15T14:00:00Z,2026-01-15T23:31:00Z,hist_001,2026-01-15T23:31:00Z,フィルターを水洗いした
evt_001,エアコンフィルター掃除,leaf,2023-10-15T14:00:00Z,2026-01-15T23:31:00Z,hist_002,2023-10-01T10:00:00Z,前回の掃除
evt_002,運転免許更新,folder,2023-10-15T14:00:00Z,2023-10-15T14:00:00Z,hist_003,2023-10-15T14:00:00Z,初回記録
```

**エラー時:**
```json
// 500 Internal Server Error
{
  "success": false,
  "error": {
    "code": "EXPORT_FAILED",
    "message": "Failed to export data"
  }
}
```

#### ステータスコード

| コード | 説明 |
|-------|------|
| 200 | エクスポート成功 |
| 401 | 認証が必要 |
| 500 | サーバー内部エラー |

## 6. レスポンシブデザイン

### 6.1 ブレークポイント別の表示

#### モバイル（0px - 640px）
- 全画面表示
- パディング: 16px
- 設定項目: 1カラム

#### タブレット（641px - 1024px）
- 全画面表示
- パディング: 24px
- 設定項目: 1カラム

#### デスクトップ（1025px以上）
- 最大幅: 768px（中央配置）
- パディング: 32px
- 設定項目: 1カラム

## 7. アクセシビリティ

### 7.1 キーボード操作
- Tab キー: フォーカス移動
- Enter キー: 設定項目を選択
- Space キー: トグルスイッチのON/OFF切り替え
- Esc キー: 設定画面を閉じる

### 7.2 スクリーンリーダー対応

```html
<!-- ヘッダー -->
<header role="banner">
  <button aria-label="戻る" @click="navigateBack">
    ←
  </button>
  <h1>設定</h1>
</header>

<!-- セクション -->
<section aria-labelledby="data-section">
  <h2 id="data-section">データ</h2>
  <button aria-label="CSVとしてエクスポート" @click="exportCSV">
    CSVとしてエクスポート
  </button>
</section>

<!-- トグルスイッチ -->
<div role="switch" 
     aria-checked="false"
     aria-label="タイムフリッパー：24時間以内は時分秒で表示"
     tabindex="0">
  <!-- トグルUI -->
</div>
```

### 7.3 フォーカス管理
- 画面表示時、戻るボタンにフォーカス
- トグル操作後、フォーカスを維持
- ダイアログ表示時、フォーカストラップ

## 8. アニメーション

### 8.1 画面遷移
- 右からスライドイン（300ms）
- 戻る時は右へスライドアウト（250ms）

### 8.2 設定項目
- タップ時: スケールダウン（0.98）
- トグル切り替え: スムーズな遷移（200ms）

### 8.3 ダイアログ
- フェードイン + スケールアップ（250ms）
- フェードアウト + スケールダウン（200ms）

## 9. エラーハンドリング

### 9.1 設定読み込みエラー
```
┌─────────────────────────────────────┐
│                                     │
│           ⚠️                        │
│                                     │
│    設定の読み込みに失敗しました      │
│                                     │
│         [再試行]                    │
│                                     │
└─────────────────────────────────────┘
```

### 9.2 設定更新エラー
- トースト通知: "設定の更新に失敗しました"
- 前の値に戻す

### 9.3 エクスポートエラー
- トースト通知: "エクスポートに失敗しました"
- リトライオプションを提供

## 10. テストケース

### 10.1 表示テスト
- [ ] 設定画面が正しく表示される
- [ ] すべてのセクションが表示される
- [ ] 現在の設定値が正しく表示される

### 10.2 ソート順テスト
- [ ] ソート順選択画面へ遷移できる
- [ ] ソート順を変更できる
- [ ] 変更が即座に反映される
- [ ] メイン画面のソート順が変更される

### 10.3 時間設定テスト
- [ ] 時間設定選択画面へ遷移できる
- [ ] 時間設定を変更できる
- [ ] 経過時間の計算ロジックが変更される

### 10.4 タイムフリッパーテスト
- [ ] トグルスイッチが動作する
- [ ] ON時に時分秒表示になる
- [ ] OFF時に日数表示になる

### 10.5 CSVエクスポートテスト
- [ ] 確認ダイアログが表示される
- [ ] エクスポートが成功する
- [ ] CSVファイルがダウンロードされる
- [ ] ファイル名が正しい
- [ ] CSV内容が正しい

### 10.6 リマインダーテスト
- [ ] リマインダー設定画面へ遷移できる
- [ ] リマインダーをON/OFFできる
- [ ] 通知タイミングを設定できる
- [ ] 通知対象イベントを設定できる

### 10.7 その他テスト
- [ ] チュートリアルトグルが動作する
- [ ] バージョン情報が表示される
- [ ] 利用規約ページへ遷移できる
- [ ] プライバシーポリシーページへ遷移できる

### 10.8 APIエラーテスト
- [ ] 設定読み込みエラー時、エラーメッセージが表示される
- [ ] 設定更新エラー時、前の値に戻る
- [ ] エクスポートエラー時、適切な処理が行われる

### 10.9 レスポンシブテスト
- [ ] モバイルで適切に表示される
- [ ] タブレットで適切に表示される
- [ ] デスクトップで適切に表示される

### 10.10 アクセシビリティテスト
- [ ] キーボードで操作できる
- [ ] スクリーンリーダーで読み上げられる
- [ ] フォーカス管理が適切に機能する

## 11. 実装優先順位（Phase 1 MVP）

### 優先度: 高
1. 設定画面の基本レイアウト
2. ソート順設定
3. 時間設定
4. タイムフリッパー
5. CSVエクスポート

### 優先度: 中
6. バージョン情報表示
7. 利用規約・プライバシーポリシーページ

### 優先度: 低（Phase 2以降）
8. リマインダー機能（UI表示のみPhase 1）
9. チュートリアル機能（UI表示のみPhase 1）
10. カスタムソート順

## 12. 技術的な実装メモ

### 12.1 コンポーネント構成（Vue 3 / Nuxt 3）

```
pages/
  settings/
    index.vue              # 設定画面
    sort.vue               # ソート順選択
    time.vue               # 時間設定選択
    reminder.vue           # リマインダー設定
      
components/
  Settings/
    SettingSection.vue     # セクション
    SettingItem.vue        # 設定項目
    SettingToggle.vue      # トグルスイッチ
    ExportDialog.vue       # エクスポート確認ダイアログ

stores/
  settings.ts              # 設定ストア

composables/
  useSettings.ts           # 設定ロジック
  useExport.ts             # エクスポートロジック
```

### 12.2 使用するライブラリ
- **UI コンポーネント**: Nuxt UI v4
  - `<UButton>`: ボタン
  - `<UToggle>`: トグルスイッチ
  - `<UModal>`: ダイアログ
  - `<URadioGroup>`: ラジオボタン
- **CSV生成**: papaparse
- **通知**: Nuxt UI Toast

### 12.3 実装例

```vue
<!-- pages/settings/index.vue -->
<template>
  <div class="min-h-screen bg-gray-50">
    <!-- ヘッダー -->
    <header class="bg-white border-b sticky top-0 z-10">
      <div class="flex items-center justify-between p-4">
        <button @click="navigateBack" aria-label="戻る">
          <UIcon name="i-heroicons-arrow-left" class="w-6 h-6" />
        </button>
        <h1 class="text-lg font-semibold">設定</h1>
        <div class="w-6" />
      </div>
    </header>
    
    <div class="max-w-3xl mx-auto">
      <!-- データセクション -->
      <SettingSection title="データ">
        <SettingItem
          label="CSVとしてエクスポート"
          @click="handleExport"
        />
      </SettingSection>
      
      <!-- 表示設定セクション -->
      <SettingSection title="表示設定">
        <SettingItem
          label="ソート順"
          :value="sortOrderLabel"
          @click="navigateTo('/settings/sort')"
        />
        <SettingItem
          label="時間設定"
          :value="timeOriginLabel"
          @click="navigateTo('/settings/time')"
        />
        <SettingToggle
          label="タイムフリッパー"
          description="24時間以内は時分秒で表示"
          :modelValue="localSettings.display.useTimeFlipper"
          @update:modelValue="toggleTimeFlipper"
        />
      </SettingSection>
      
      <!-- 通知セクション -->
      <SettingSection title="通知">
        <SettingItem
          label="リマインダー"
          @click="navigateTo('/settings/reminder')"
        />
      </SettingSection>
      
      <!-- その他セクション -->
      <SettingSection title="その他">
        <SettingToggle
          label="チュートリアル"
          :modelValue="serverSettings.misc.showTutorial"
          @update:modelValue="toggleTutorial"
        />
      </SettingSection>
      
      <!-- アプリ情報セクション -->
      <SettingSection title="アプリ情報">
        <SettingItem
          label="バージョン"
          :value="appVersion"
          :clickable="false"
        />
        <SettingItem
          label="利用規約"
          @click="navigateTo('/terms')"
        />
        <SettingItem
          label="プライバシーポリシー"
          @click="navigateTo('/privacy')"
        />
      </SettingSection>
    </div>
    
    <!-- エクスポート確認ダイアログ -->
    <ExportDialog 
      v-model="showExportDialog"
      @confirm="confirmExport"
    />
  </div>
</template>

<script setup lang="ts">
const router = useRouter();
const settingsStore = useSettingsStore();
const { localSettings, serverSettings } = storeToRefs(settingsStore);

const showExportDialog = ref(false);
const appVersion = '1.0.0';

const sortOrderLabel = computed(() => {
  const labels = {
    alphabetical: 'アルファベット順',
    date_desc: '日時降順（最新が上）',
    date_asc: '日時昇順（古いものが上）',
    custom: 'カスタム',
  };
  return labels[localSettings.value.display.sortOrder];
});

const timeOriginLabel = computed(() => {
  const labels = {
    midnight: '真夜中を起点とする',
    '24hours': '24時間ごと',
  };
  return labels[localSettings.value.display.timeOrigin];
});

const handleExport = () => {
  showExportDialog.value = true;
};

const confirmExport = async () => {
  try {
    const blob = await $fetch('/export/csv', {
      responseType: 'blob',
    });
    
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `when-is-the-last-time_${dayjs().format('YYYYMMDD_HHmmss')}.csv`;
    link.click();
    window.URL.revokeObjectURL(url);
    
    showToast('データをエクスポートしました');
  } catch (error) {
    showToast('エクスポートに失敗しました', 'error');
  }
};

const toggleTimeFlipper = () => {
  settingsStore.toggleTimeFlipper();
  // ローカルストレージに即座に保存されるので、async不要
};

const toggleTutorial = async () => {
  const success = await settingsStore.toggleTutorial();
  if (success && serverSettings.value.misc.showTutorial) {
    showToast('次回起動時にチュートリアルが表示されます');
  }
};

const navigateBack = () => {
  router.back();
};

onMounted(() => {
  settingsStore.loadAllSettings();
});
</script>
```

```vue
<!-- pages/settings/sort.vue -->
<template>
  <div class="min-h-screen bg-gray-50">
    <header class="bg-white border-b sticky top-0 z-10">
      <div class="flex items-center justify-between p-4">
        <button @click="navigateBack" aria-label="戻る">
          <UIcon name="i-heroicons-arrow-left" class="w-6 h-6" />
        </button>
        <h1 class="text-lg font-semibold">ソート順</h1>
        <div class="w-6" />
      </div>
    </header>
    
    <URadioGroup
      v-model="selectedSort"
      :options="sortOptions"
      class="p-4"
      @change="handleSortChange"
    />
  </div>
</template>

<script setup lang="ts">
const router = useRouter();
const settingsStore = useSettingsStore();
const { localSettings } = storeToRefs(settingsStore);

const selectedSort = ref(localSettings.value.display.sortOrder);

const sortOptions = [
  { value: 'alphabetical', label: 'アルファベット順' },
  { value: 'date_desc', label: '日時降順（最新が上）' },
  { value: 'date_asc', label: '日時昇順（古いものが上）' },
  // { value: 'custom', label: 'カスタム', disabled: true },
];

const handleSortChange = () => {
  settingsStore.updateSortOrder(selectedSort.value);
  // ローカルストレージに即座に保存されるので、async不要
  router.back();
};

const navigateBack = () => {
  router.back();
};
</script>
```

**注意:** ソート順の変更は即座にローカルストレージに保存され、メイン画面のイベント一覧にリアクティブに反映されます。

## 13. 今後の拡張性

### Phase 2以降で追加予定
- カスタムソート順（ドラッグ&ドロップ）
- 24時間ごとの時間設定
- 実際のチュートリアル機能
- ダークモード設定
- 言語設定（多言語対応）
- テーマカラー設定
- データインポート（CSV）
- 自動バックアップ設定

### Phase 4以降で追加予定
- 実際のリマインダー通知機能
- プッシュ通知設定
- 通知音設定
- バイブレーション設定

---

**作成日**: 2026/01/16  
**バージョン**: 1.0  
**更新履歴**:
- 2026/01/16: 初版作成
