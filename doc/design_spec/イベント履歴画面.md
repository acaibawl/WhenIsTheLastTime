# イベント履歴画面設計書

## 1. 画面概要

### 1.1 画面名
イベント履歴画面

### 1.2 目的
特定のイベントの実行履歴を表示・管理する画面。統計情報や時系列の履歴を確認し、新しい履歴エントリの追加や既存エントリの編集・削除を行える。

### 1.3 アクセス方法
- メイン画面のイベントカードをタップ
- URL: `/events/:id/history`

### 1.4 URL設計

#### フロントエンドURL
```
ベースURL: https://example.com

# イベント履歴画面（:idはイベントID）
/events/:id/history

# 例
/events/evt_1234567890/history
```

#### バックエンドAPI URL
```
ベースURL: https://api.example.com

# イベント詳細取得
GET /events/:id

# 履歴一覧取得
GET /events/:id/history

# 履歴エントリ追加
POST /events/:id/history

# 履歴エントリ更新
PUT /events/:id/history/:historyId

# 履歴エントリ削除
DELETE /events/:id/history/:historyId
```

## 2. 画面構成

### 2.1 レイアウト構成

```
┌─────────────────────────────────────┐
│ ←  🍃 エアコンフィルター掃除  ⋮ │ ← ヘッダー
├─────────────────────────────────────┤
│                                     │
│  今週 0回 ｜ 今月 0回 ｜ 合計 5回  │ ← 統計バッジ
│                                     │
├─────────────────────────────────────┤
│                                     │
│  2年3ヶ月15日ごと                   │ ← 履歴統計
│  38日平均                           │
│  5合計                              │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  2026年1月                          │ ← 年月グループ
│  ┌──────────────────────────────┐  │
│  │  ●  15   フィルターを水洗い  │  │ ← 履歴エントリ
│  │     水  23:31  2日前         │  │
│  └──────────────────────────────┘  │
│                                     │
│  2023年10月                         │
│  ┌──────────────────────────────┐  │
│  │  ●  01   前回の掃除          │  │
│  │     金  10:00  2年3ヶ月前    │  │
│  └──────────────────────────────┘  │
│                                     │
│  ┌──────────────────────────────┐  │
│  │  ●  15   初回記録            │  │
│  │     日  14:00  2年3ヶ月前    │  │
│  └──────────────────────────────┘  │
│                                     │
│                    [+ 履歴を追加]   │ ← FAB
└─────────────────────────────────────┘
```

### 2.2 UI コンポーネント構成

#### ヘッダー（Header）

**左側: 戻るボタン**
- アイコン: ← (矢印)
- アクション: メイン画面に戻る
- 位置: 左端

**中央: イベント情報**
- カテゴリーアイコン + イベント名
- フォントサイズ: 18px（モバイル）、20px（デスクトップ）
- フォントウェイト: 600（Semi-Bold）
- アイコンサイズ: 24x24px

**右側: メニューボタン**
- アイコン: ⋮（縦三点リーダー）
- アクション: ドロップダウンメニュー表示
  - 編集
  - 削除
- 位置: 右端

#### 統計バッジ（Statistics Badges）

**レイアウト:**
- 3つのバッジを横並び
- 区切り文字: ｜（縦棒）
- パディング: 16px（上下）、20px（左右）
- 背景色: グレー薄め (#F9FAFB)

**各バッジ:**
```typescript
interface StatisticsBadge {
  label: string;      // "今週"、"今月"、"合計"
  count: number;      // 回数
}
```

**スタイル:**
- ラベルフォントサイズ: 14px
- カウントフォントサイズ: 18px
- カウントフォントウェイト: 700（Bold）
- カウント色: プライマリーカラー (#3B82F6)
- ラベル色: グレー (#6B7280)

**計算ロジック:**
- **今週**: 今週（月曜日〜日曜日）の履歴エントリ数
- **今月**: 今月（1日〜月末）の履歴エントリ数
- **合計**: 全履歴エントリ数

#### 履歴統計（History Statistics）

**レイアウト:**
- 3行の統計情報
- パディング: 20px（上下）、20px（左右）
- 背景色: 白 (#FFFFFF)
- ボーダー下部: 1px solid #E5E7EB

**表示項目:**
```typescript
interface HistoryStatistics {
  averageInterval: string;  // "2年3ヶ月15日ごと"
  averageDays: string;      // "38日平均"
  totalCount: string;       // "5合計"
}
```

**スタイル:**
- フォントサイズ: 16px
- 行間: 8px
- 数値部分: Bold (#1F2937)
- ラベル部分: Regular (#6B7280)

**計算ロジック:**
```typescript
// 平均間隔（○○日ごと）
const calculateAverageInterval = (histories: History[]): string => {
  if (histories.length < 2) return '-';
  
  const sortedHistories = histories.sort((a, b) => 
    new Date(b.executedAt).getTime() - new Date(a.executedAt).getTime()
  );
  
  let totalDays = 0;
  for (let i = 0; i < sortedHistories.length - 1; i++) {
    const diff = dayjs(sortedHistories[i].executedAt)
      .diff(dayjs(sortedHistories[i + 1].executedAt), 'day');
    totalDays += diff;
  }
  
  const avgDays = Math.round(totalDays / (sortedHistories.length - 1));
  return formatDuration(avgDays);
};

// 平均日数
const calculateAverageDays = (histories: History[]): number => {
  if (histories.length < 2) return 0;
  // 上記と同じロジック
  return avgDays;
};

// 期間のフォーマット（例: "2年3ヶ月15日ごと"）
const formatDuration = (days: number): string => {
  const years = Math.floor(days / 365);
  const months = Math.floor((days % 365) / 30);
  const remainingDays = days % 30;
  
  let result = '';
  if (years > 0) result += `${years}年`;
  if (months > 0) result += `${months}ヶ月`;
  if (remainingDays > 0 || result === '') result += `${remainingDays}日`;
  result += 'ごと';
  
  return result;
};
```

#### 履歴リスト（History List）

**年月グループヘッダー:**
- フォーマット: "YYYY年MM月"
- 例: "2026年1月"
- フォントサイズ: 14px
- フォントウェイト: 600（Semi-Bold）
- 色: グレー (#6B7280)
- パディング: 12px（上）、20px（左右）、8px（下）
- 背景色: グレー薄め (#F9FAFB)

**履歴エントリカード:**

構造:
```
┌──────────────────────────────────┐
│  ●  15   フィルターを水洗いした    │ ← 日付バッジ + メモ
│     水  23:31  2日前              │ ← 曜日 + 時刻 + 経過時間
└──────────────────────────────────┘
```

**日付バッジ（左側）:**
- 円形デザイン
- 直径: 48px
- 背景色: プライマリーカラー薄め (#EFF6FF)
- ボーダー: 2px solid プライマリーカラー (#3B82F6)
- 日付（数字）: 24px、Bold、中央配置
- 小さな点（●）: 履歴があることを示すインジケーター

**メモ（右側メイン）:**
- フォントサイズ: 16px
- フォントウェイト: 500（Medium）
- 色: ダークグレー (#1F2937)
- 最大表示行数: 2行
- 超過時: "..." で省略

**サブ情報（右側下部）:**
- 曜日: 漢字1文字（月火水木金土日）
- 時刻: HH:mm形式
- 経過時間: "○日前"、"○週間前"、"○ヶ月前"、"○年前"
- フォントサイズ: 14px
- 色: グレー (#6B7280)
- 区切り: スペース2文字

**カードスタイル:**
- パディング: 16px
- マージン: 8px（上下）、16px（左右）
- 背景色: 白 (#FFFFFF)
- ボーダーラジアス: 12px
- シャドウ: 0 1px 3px rgba(0, 0, 0, 0.1)
- ホバー時: シャドウ強調

**タップ時のアクション:**
- メモ入力画面へ遷移（編集モード）

#### フローティングアクションボタン（FAB）

**スタイル:**
- 位置: 画面右下固定
- サイズ: 56x56px（モバイル）、64x64px（デスクトップ）
- アイコン: + 履歴を追加
- 背景色: プライマリーカラー (#3B82F6)
- テキスト色: 白 (#FFFFFF)
- シャドウ: 0 4px 6px rgba(0, 0, 0, 0.1)

**アクション:**
- メモ入力画面へ遷移（新規作成モード）

## 3. 機能詳細

### 3.1 履歴表示フロー

```
1. メイン画面でイベントカードタップ
   ↓
2. 履歴画面表示 + ローディング
   ↓
3. API呼び出し
   - GET /events/:id（イベント情報）
   - GET /events/:id/history（履歴一覧）
   ↓
4. データ表示
   - ヘッダー（イベント名・アイコン）
   - 統計情報計算
   - 履歴リスト表示（年月でグループ化）
```

### 3.2 履歴の追加

```
1. FABタップ
   ↓
2. メモ入力画面表示（新規モード）
   - デフォルト日時: 現在日時
   - メモ: 空
   ↓
3. ユーザーが入力
   - 日時選択
   - メモ入力（任意）
   ↓
4. 完了ボタンタップ
   ↓
5. API呼び出し（POST /events/:id/history）
   ↓
6. 成功 → 履歴画面に戻る + 再読み込み + トースト通知
   失敗 → エラーメッセージ表示
```

### 3.3 履歴の編集

```
1. 履歴エントリカードタップ
   ↓
2. メモ入力画面表示（編集モード）
   - 既存の日時・メモを表示
   ↓
3. ユーザーが編集
   ↓
4. 完了ボタンタップ
   ↓
5. API呼び出し（PUT /events/:id/history/:historyId）
   ↓
6. 成功 → 履歴画面に戻る + 再読み込み + トースト通知
   失敗 → エラーメッセージ表示
```

### 3.4 イベントの編集・削除

#### メニュー表示
ヘッダー右側の ⋮ ボタンタップでドロップダウンメニュー表示：

```
┌─────────────────┐
│  ✏️  編集       │
│  🗑️  削除       │
└─────────────────┘
```

#### 編集
- イベント作成・編集画面へ遷移（編集モード）
- URL: `/events/:id/edit`

#### 削除
確認ダイアログ表示：
```
┌─────────────────────────────────────┐
│                                     │
│  このイベントを削除しますか？        │
│                                     │
│  "エアコンフィルター掃除"            │
│  およびすべての履歴が削除されます。  │
│  この操作は取り消せません。          │
│                                     │
│  ┌─────────┐  ┌─────────┐          │
│  │キャンセル│  │  削除   │          │
│  └─────────┘  └─────────┘          │
│                                     │
└─────────────────────────────────────┘
```

- **キャンセル**: ダイアログを閉じる
- **削除**: API呼び出し（DELETE /events/:id） → メイン画面に戻る

### 3.5 履歴エントリの削除

#### 削除制約
**履歴は最低1件必須**
- イベントには常に1件以上の履歴が存在する必要がある
- 履歴が1件のみの場合、削除ボタンは非活性または非表示にする
- APIでも最後の1件の削除はエラーを返す

```typescript
// 削除可能判定ロジック
const canDeleteHistory = (histories: History[]): boolean => {
  return histories.length > 1;
};

// UI表示ロジック
const isDeleteButtonDisabled = computed(() => {
  return histories.value.length <= 1;
});
```

**最後の1件削除時のUI:**
```
┌─────────────────────────────────────┐
│                                     │
│  削除ボタン (グレーアウト・非活性)  │
│                                     │
│  ※ 最低1件の履歴が必要です          │
│                                     │
└─────────────────────────────────────┘
```

#### 削除方法

**方法1: スワイプ削除（Phase 2以降）**
- 履歴エントリを左にスワイプ
- 削除ボタンが表示される（履歴が2件以上の場合のみ）
- タップで削除
- 履歴が1件のみの場合、スワイプ操作は無効

**方法2: 編集画面から削除**
- 履歴エントリタップ → メモ入力画面
- 削除ボタンをタップ（履歴が2件以上の場合のみ活性）
- 確認ダイアログ表示

```
┌─────────────────────────────────────┐
│                                     │
│  この履歴を削除しますか？            │
│                                     │
│  2026/01/15 23:31                   │
│  フィルターを水洗いした              │
│                                     │
│  ┌─────────┐  ┌─────────┐          │
│  │キャンセル│  │  削除   │          │
│  └─────────┘  └─────────┘          │
│                                     │
└─────────────────────────────────────┘
```

## 4. 状態管理

### 4.1 コンポーネント状態

```typescript
interface EventHistoryState {
  // イベント情報
  event: Event | null;
  
  // 履歴データ
  histories: History[];
  
  // 統計情報（計算値）
  statistics: {
    thisWeek: number;
    thisMonth: number;
    total: number;
    averageInterval: string;
    averageDays: number;
  };
  
  // UI状態
  isLoading: boolean;
  showMenu: boolean;
  showDeleteDialog: boolean;
  
  // エラー
  error: string | null;
}

interface Event {
  id: string;
  name: string;
  categoryIcon: CategoryType;
  lastExecutedHistoryId: string | null;
  lastExecutedAt: string | null;   // 履歴から取得
  lastExecutedMemo: string | null; // 履歴から取得
  createdAt: string;
  updatedAt: string;
}

interface History {
  id: string;
  eventId: string;
  executedAt: string;    // ISO 8601形式
  memo?: string;
  createdAt: string;
  updatedAt: string;
}
```

### 4.2 Composable（例）

```typescript
// composables/useEventHistory.ts
export const useEventHistory = (eventId: string) => {
  const event = ref<Event | null>(null);
  const histories = ref<History[]>([]);
  const isLoading = ref(false);
  const error = ref<string | null>(null);
  
  // イベント情報と履歴を取得
  const loadData = async () => {
    isLoading.value = true;
    error.value = null;
    
    try {
      // 並列で取得
      const [eventData, historyData] = await Promise.all([
        $fetch(`/events/${eventId}`),
        $fetch(`/events/${eventId}/history`),
      ]);
      
      event.value = eventData.data.event;
      histories.value = historyData.data.histories;
    } catch (err) {
      error.value = 'データの読み込みに失敗しました';
    } finally {
      isLoading.value = false;
    }
  };
  
  // 統計情報を計算
  const statistics = computed(() => {
    const now = dayjs();
    const startOfWeek = now.startOf('week');
    const startOfMonth = now.startOf('month');
    
    return {
      thisWeek: histories.value.filter(h => 
        dayjs(h.executedAt).isAfter(startOfWeek)
      ).length,
      thisMonth: histories.value.filter(h => 
        dayjs(h.executedAt).isAfter(startOfMonth)
      ).length,
      total: histories.value.length,
      averageInterval: calculateAverageInterval(histories.value),
      averageDays: calculateAverageDays(histories.value),
    };
  });
  
  // 年月でグループ化
  const groupedHistories = computed(() => {
    const groups: Record<string, History[]> = {};
    
    histories.value.forEach(history => {
      const yearMonth = dayjs(history.executedAt).format('YYYY年MM月');
      if (!groups[yearMonth]) {
        groups[yearMonth] = [];
      }
      groups[yearMonth].push(history);
    });
    
    // 降順にソート
    return Object.entries(groups).sort((a, b) => 
      b[0].localeCompare(a[0])
    );
  });
  
  // イベント削除
  const deleteEvent = async () => {
    try {
      await $fetch(`/events/${eventId}`, {
        method: 'DELETE',
      });
      showToast('イベントを削除しました');
      navigateTo('/');
    } catch (err) {
      error.value = 'イベントの削除に失敗しました';
    }
  };
  
  return {
    event,
    histories,
    isLoading,
    error,
    statistics,
    groupedHistories,
    loadData,
    deleteEvent,
  };
};
```

## 5. API仕様

### 5.1 イベント詳細取得

#### エンドポイント
```
GET /events/:id
```

詳細は[イベント作成・編集画面設計書](./イベント作成・編集画面.md#52-イベント詳細取得編集時)を参照。

### 5.2 履歴一覧取得

#### エンドポイント
```
GET /events/:id/history
```

#### パスパラメータ
- `id`: イベントID

#### クエリパラメータ
なし（全履歴を取得）

#### リクエスト例
```bash
GET /events/evt_1234567890/history
```

#### レスポンス

**成功時（200 OK）:**
```typescript
interface GetHistoriesResponse {
  success: true;
  data: {
    histories: History[];
  };
}

interface History {
  id: string;
  eventId: string;
  executedAt: string;    // ISO 8601形式
  memo?: string;
  createdAt: string;
  updatedAt: string;
}
```

**レスポンス例:**
```json
{
  "success": true,
  "data": {
    "histories": [
      {
        "id": "hist_1111111111",
        "eventId": "evt_1234567890",
        "executedAt": "2026-01-15T23:31:00Z",
        "memo": "フィルターを水洗いした",
        "createdAt": "2026-01-15T23:31:00Z",
        "updatedAt": "2026-01-15T23:31:00Z"
      },
      {
        "id": "hist_2222222222",
        "eventId": "evt_1234567890",
        "executedAt": "2023-10-01T10:00:00Z",
        "memo": "前回の掃除",
        "createdAt": "2023-10-01T10:00:00Z",
        "updatedAt": "2023-10-01T10:00:00Z"
      },
      {
        "id": "hist_3333333333",
        "eventId": "evt_1234567890",
        "executedAt": "2023-10-15T14:00:00Z",
        "memo": "初回記録",
        "createdAt": "2023-10-15T14:00:00Z",
        "updatedAt": "2023-10-15T14:00:00Z"
      }
    ]
  }
}
```

**エラー時:**
```json
// 404 Not Found
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "Event not found"
  }
}
```

#### ステータスコード

| コード | 説明 |
|-------|------|
| 200 | 成功 |
| 401 | 認証が必要 |
| 404 | イベントが見つからない |
| 500 | サーバー内部エラー |

### 5.3 履歴エントリ追加

#### エンドポイント
```
POST /events/:id/history
```

#### パスパラメータ
- `id`: イベントID

#### リクエストボディ
```typescript
interface CreateHistoryRequest {
  executedAt: string;    // 実行日時（ISO 8601形式、必須）
  memo?: string;         // メモ（任意、最大500文字）
}
```

#### リクエスト例
```json
POST /events/evt_1234567890/history

{
  "executedAt": "2026-01-16T15:30:00Z",
  "memo": "今回は念入りに掃除した"
}
```

#### レスポンス

**成功時（201 Created）:**
```typescript
interface CreateHistoryResponse {
  success: true;
  data: {
    history: History;
  };
}
```

**レスポンス例:**
```json
{
  "success": true,
  "data": {
    "history": {
      "id": "hist_4444444444",
      "eventId": "evt_1234567890",
      "executedAt": "2026-01-16T15:30:00Z",
      "memo": "今回は念入りに掃除した",
      "createdAt": "2026-01-16T15:30:00Z",
      "updatedAt": "2026-01-16T15:30:00Z"
    }
  }
}
```

**エラー時:**
```json
// 400 Bad Request
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力内容に誤りがあります",
    "details": {
      "executedAt": "実行日時は必須です"
    }
  }
}
```

#### ステータスコード

| コード | 説明 |
|-------|------|
| 201 | 作成成功 |
| 400 | バリデーションエラー |
| 401 | 認証が必要 |
| 404 | イベントが見つからない |
| 500 | サーバー内部エラー |

**注意事項:**
- 履歴エントリを追加すると、親イベントの `lastExecutedHistoryId` が自動的に更新される
- 最新の履歴エントリのIDが `lastExecutedHistoryId` になる

### 5.4 履歴エントリ更新

#### エンドポイント
```
PUT /events/:id/history/:historyId
```

#### パスパラメータ
- `id`: イベントID
- `historyId`: 履歴ID

#### リクエストボディ
```typescript
interface UpdateHistoryRequest {
  executedAt: string;    // 実行日時（ISO 8601形式、必須）
  memo?: string;         // メモ（任意、最大500文字）
}
```

#### リクエスト例
```json
PUT /events/evt_1234567890/history/hist_1111111111

{
  "executedAt": "2026-01-15T23:31:00Z",
  "memo": "フィルターを水洗いし、乾燥させた"
}
```

#### レスポンス

**成功時（200 OK）:**
```typescript
interface UpdateHistoryResponse {
  success: true;
  data: {
    history: History;
  };
}
```

**レスポンス例:**
```json
{
  "success": true,
  "data": {
    "history": {
      "id": "hist_1111111111",
      "eventId": "evt_1234567890",
      "executedAt": "2026-01-15T23:31:00Z",
      "memo": "フィルターを水洗いし、乾燥させた",
      "createdAt": "2026-01-15T23:31:00Z",
      "updatedAt": "2026-01-16T10:00:00Z"
    }
  }
}
```

**エラー時:**
```json
// 404 Not Found
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "History not found"
  }
}
```

#### ステータスコード

| コード | 説明 |
|-------|------|
| 200 | 更新成功 |
| 400 | バリデーションエラー |
| 401 | 認証が必要 |
| 404 | 履歴が見つからない |
| 500 | サーバー内部エラー |

**注意事項:**
- 履歴エントリを更新すると、親イベントの `lastExecutedHistoryId` も再計算される
- 最新の `executedAt` を持つ履歴IDが `lastExecutedHistoryId` になる

### 5.5 履歴エントリ削除

#### エンドポイント
```
DELETE /events/:id/history/:historyId
```

#### パスパラメータ
- `id`: イベントID
- `historyId`: 履歴ID

#### リクエスト例
```bash
DELETE /events/evt_1234567890/history/hist_1111111111
```

#### レスポンス

**成功時（200 OK）:**
```typescript
interface DeleteHistoryResponse {
  success: true;
  message: string;
}
```

**レスポンス例:**
```json
{
  "success": true,
  "message": "History deleted successfully"
}
```

**エラー時:**
```json
// 404 Not Found
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "History not found"
  }
}

// 400 Bad Request（最後の1件を削除しようとした場合）
{
  "success": false,
  "error": {
    "code": "LAST_HISTORY_DELETE_NOT_ALLOWED",
    "message": "Cannot delete the last history entry. At least one history is required."
  }
}
```

#### ステータスコード

| コード | 説明 |
|-------|------|
| 200 | 削除成功 |
| 400 | 最後の履歴削除エラー（最低1件必須） |
| 401 | 認証が必要 |
| 404 | 履歴が見つからない |
| 500 | サーバー内部エラー |

**注意事項:**
- **履歴は最低1件必須**: 最後の1件の履歴エントリは削除不可
- 削除リクエスト時、対象イベントの履歴が1件のみの場合は400エラーを返す
- 履歴エントリを削除すると、親イベントの `lastExecutedHistoryId` も再計算される
- 削除後に残っている最新の `executedAt` を持つ履歴IDが `lastExecutedHistoryId` になる

### 5.6 イベント削除

#### エンドポイント
```
DELETE /events/:id
```

#### パスパラメータ
- `id`: イベントID

#### リクエスト例
```bash
DELETE /events/evt_1234567890
```

#### レスポンス

**成功時（200 OK）:**
```typescript
interface DeleteEventResponse {
  success: true;
  message: string;
}
```

**レスポンス例:**
```json
{
  "success": true,
  "message": "Event and all histories deleted successfully"
}
```

**エラー時:**
```json
// 404 Not Found
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "Event not found"
  }
}
```

#### ステータスコード

| コード | 説明 |
|-------|------|
| 200 | 削除成功 |
| 401 | 認証が必要 |
| 404 | イベントが見つからない |
| 500 | サーバー内部エラー |

**注意事項:**
- イベントを削除すると、関連するすべての履歴エントリも削除される（カスケード削除）

## 6. レスポンシブデザイン

### 6.1 ブレークポイント別の表示

#### モバイル（0px - 640px）
- 全画面表示
- パディング: 16px
- 統計バッジ: 縦並び（必要に応じて）
- 履歴エントリ: 1カラム

#### タブレット（641px - 1024px）
- 全画面表示
- パディング: 24px
- 統計バッジ: 横並び
- 履歴エントリ: 1カラム

#### デスクトップ（1025px以上）
- 最大幅: 1024px（中央配置）
- パディング: 32px
- 統計バッジ: 横並び
- 履歴エントリ: 2カラム（グリッド）

## 7. アクセシビリティ

### 7.1 キーボード操作
- Tab キー: フォーカス移動
- Enter キー: 履歴エントリを開く
- Esc キー: メニューを閉じる

### 7.2 スクリーンリーダー対応

```html
<!-- ヘッダー -->
<header role="banner">
  <button aria-label="戻る" @click="navigateBack">
    ←
  </button>
  <h1 aria-label="エアコンフィルター掃除の履歴">
    🍃 エアコンフィルター掃除
  </h1>
  <button aria-label="メニューを開く" aria-haspopup="menu">
    ⋮
  </button>
</header>

<!-- 統計バッジ -->
<div role="region" aria-label="統計情報">
  <span aria-label="今週0回">今週 0回</span>
  <span aria-label="今月0回">今月 0回</span>
  <span aria-label="合計5回">合計 5回</span>
</div>

<!-- 履歴リスト -->
<div role="feed" aria-label="履歴一覧">
  <h2>2026年1月</h2>
  <article 
    role="article"
    aria-label="2026年1月15日 水曜日 23時31分、フィルターを水洗いした、2日前"
    tabindex="0"
  >
    <!-- 履歴エントリ内容 -->
  </article>
</div>
```

### 7.3 フォーカス管理
- 画面表示時、戻るボタンにフォーカス
- メニュー開閉時、適切にフォーカス移動
- モーダル内でフォーカストラップ

## 8. アニメーション

### 8.1 画面遷移
- 右からスライドイン（300ms）
- 戻る時は右へスライドアウト（250ms）

### 8.2 履歴エントリ
- リスト表示時: スタガードアニメーション（各アイテム50ms遅延）
- タップ時: スケールダウン（0.98）
- 削除時: フェードアウト + スライドアウト

### 8.3 統計情報
- 数値変更時: カウントアップアニメーション（500ms）

## 9. エラーハンドリング

### 9.1 データ読み込みエラー
```
┌─────────────────────────────────────┐
│                                     │
│           ⚠️                        │
│                                     │
│    データの読み込みに失敗しました    │
│                                     │
│         [再試行]                    │
│                                     │
└─────────────────────────────────────┘
```

### 9.2 削除エラー
- トースト通知: "削除に失敗しました"
- リトライオプションを提供

### 9.3 ネットワークエラー
- オフライン検出
- 適切なメッセージ表示
- 再接続時に自動リロード

## 10. テストケース

### 10.1 表示テスト
- [ ] イベント情報（名前・アイコン）が表示される
- [ ] 統計バッジが正しく表示される
- [ ] 統計情報が正しく計算・表示される
- [ ] 履歴が年月でグループ化される
- [ ] 履歴が新しい順に表示される

### 10.2 統計計算テスト
- [ ] 今週の回数が正しく計算される
- [ ] 今月の回数が正しく計算される
- [ ] 合計回数が正しく計算される
- [ ] 平均間隔が正しく計算される
- [ ] 平均日数が正しく計算される

### 10.3 履歴操作テスト
- [ ] FABタップで履歴追加画面へ遷移する
- [ ] 履歴エントリタップで編集画面へ遷移する
- [ ] 履歴追加が成功する
- [ ] 履歴更新が成功する
- [ ] 履歴削除が成功する（履歴が2件以上の場合）
- [ ] 履歴が1件のみの場合、削除ボタンが非活性になる
- [ ] 最後の履歴削除時に適切なエラーメッセージが表示される

### 10.4 イベント操作テスト
- [ ] メニューが正しく表示される
- [ ] 編集ボタンで編集画面へ遷移する
- [ ] 削除確認ダイアログが表示される
- [ ] イベント削除が成功する
- [ ] 削除後メイン画面に戻る

### 10.5 APIエラーテスト
- [ ] データ読み込みエラー時、エラーメッセージが表示される
- [ ] 404エラー時、適切なメッセージが表示される
- [ ] ネットワークエラー時、適切な処理が行われる

### 10.6 レスポンシブテスト
- [ ] モバイルで適切に表示される
- [ ] タブレットで適切に表示される
- [ ] デスクトップで適切に表示される

### 10.7 アクセシビリティテスト
- [ ] キーボードで操作できる
- [ ] スクリーンリーダーで読み上げられる
- [ ] フォーカス管理が適切に機能する

## 11. 実装優先順位（Phase 1 MVP）

### 優先度: 高
1. イベント情報表示
2. 統計バッジ表示
3. 履歴リスト表示（年月グループ化）
4. 履歴追加
5. 履歴編集
6. イベント削除

### 優先度: 中
7. 統計情報計算（平均間隔・平均日数）
8. エラーハンドリング
9. ローディング表示

### 優先度: 低（Phase 2以降）
10. 履歴エントリのスワイプ削除
11. アニメーションの詳細調整
12. デスクトップでの2カラム表示
13. 履歴のフィルタリング・検索

## 12. 技術的な実装メモ

### 12.1 コンポーネント構成（Vue 3 / Nuxt 3）

```
pages/
  events/
    [id]/
      history.vue          # 履歴画面
      
components/
  EventHistory/
    StatisticsBadges.vue   # 統計バッジ
    HistoryStatistics.vue  # 履歴統計
    HistoryList.vue        # 履歴リスト
    HistoryEntry.vue       # 履歴エントリカード

composables/
  useEventHistory.ts       # 履歴ロジック
  useHistoryStatistics.ts  # 統計計算ロジック
```

### 12.2 使用するライブラリ
- **日時処理**: dayjs
- **UI コンポーネント**: Nuxt UI v4
  - `<UButton>`: ボタン
  - `<UDropdown>`: ドロップダウンメニュー
  - `<UModal>`: 確認ダイアログ
  - `<UBadge>`: バッジ
- **アニメーション**: Vue Transition
- **通知**: Nuxt UI Toast

### 12.3 実装例

```vue
<!-- pages/events/[id]/history.vue -->
<template>
  <div class="min-h-screen bg-gray-50">
    <!-- ヘッダー -->
    <header class="bg-white border-b sticky top-0 z-10">
      <div class="flex items-center justify-between p-4">
        <button @click="navigateBack" aria-label="戻る">
          <UIcon name="i-heroicons-arrow-left" class="w-6 h-6" />
        </button>
        <div class="flex items-center gap-2">
          <span class="text-2xl">{{ event?.categoryIcon }}</span>
          <h1 class="text-lg font-semibold">{{ event?.name }}</h1>
        </div>
        <UDropdown :items="menuItems">
          <UButton icon="i-heroicons-ellipsis-vertical" variant="ghost" />
        </UDropdown>
      </div>
    </header>
    
    <!-- 統計バッジ -->
    <StatisticsBadges :statistics="statistics" />
    
    <!-- 履歴統計 -->
    <HistoryStatistics :statistics="statistics" />
    
    <!-- 履歴リスト -->
    <HistoryList 
      :grouped-histories="groupedHistories"
      @select="handleSelectHistory"
    />
    
    <!-- FAB -->
    <UButton
      icon="i-heroicons-plus"
      label="履歴を追加"
      class="fixed bottom-4 right-4"
      size="lg"
      @click="handleAddHistory"
    />
    
    <!-- 削除確認ダイアログ -->
    <UModal v-model="showDeleteDialog">
      <div class="p-6">
        <h2 class="text-lg font-semibold mb-4">
          このイベントを削除しますか？
        </h2>
        <p class="text-gray-600 mb-2">"{{ event?.name }}"</p>
        <p class="text-gray-600 mb-6">
          およびすべての履歴が削除されます。<br>
          この操作は取り消せません。
        </p>
        <div class="flex gap-4 justify-end">
          <UButton variant="ghost" @click="showDeleteDialog = false">
            キャンセル
          </UButton>
          <UButton color="red" @click="handleDeleteEvent">
            削除
          </UButton>
        </div>
      </div>
    </UModal>
  </div>
</template>

<script setup lang="ts">
const route = useRoute();
const router = useRouter();
const eventId = route.params.id as string;

const {
  event,
  histories,
  isLoading,
  statistics,
  groupedHistories,
  loadData,
  deleteEvent,
} = useEventHistory(eventId);

const showDeleteDialog = ref(false);

const menuItems = [
  [{
    label: '編集',
    icon: 'i-heroicons-pencil',
    click: () => router.push(`/events/${eventId}/edit`),
  }],
  [{
    label: '削除',
    icon: 'i-heroicons-trash',
    click: () => showDeleteDialog.value = true,
  }],
];

const handleAddHistory = () => {
  router.push(`/events/${eventId}/history/new`);
};

const handleSelectHistory = (historyId: string) => {
  router.push(`/events/${eventId}/history/${historyId}/edit`);
};

const handleDeleteEvent = async () => {
  await deleteEvent();
};

const navigateBack = () => {
  router.push('/');
};

onMounted(() => {
  loadData();
});
</script>
```

## 13. 今後の拡張性

### Phase 2以降で追加予定
- 履歴のスワイプ削除
- 履歴のフィルタリング・検索
- 履歴のエクスポート（CSV）
- グラフ・チャート表示（実行頻度の可視化）
- 写真添付機能
- 次回予定表示
- リマインダー設定

---

**作成日**: 2026/01/16  
**バージョン**: 1.0  
**更新履歴**:
- 2026/01/16: 初版作成
