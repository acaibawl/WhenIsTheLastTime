# 会員登録設計書

## 1. 概要

### 1.1 目的
「最後はいつ？ (When Is The Last Time)」アプリケーションにおける会員登録機能の設計を定義する。

### 1.2 登録方式
- **メールアドレス認証方式**: メールアドレスとパスワードによる登録
- **認証コード確認**: メール送信による本人確認

### 1.3 セキュリティ方針
- パスワードはbcryptでハッシュ化して保存
- 認証コードはRedisで一時保管（有効期限付き）
- レート制限による不正アクセス防止
- ユーザー列挙攻撃対策（メール重複時も同一レスポンス）

## 2. 会員登録フロー

### 2.1 フロー図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              会員登録フロー                                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  STEP 1    │     │  STEP 2    │     │  STEP 3    │     │  STEP 4    │
│ 情報入力   │ ──▶ │ 認証コード │ ──▶ │ コード検証 │ ──▶ │ 登録完了   │
│            │     │   送信     │     │            │     │            │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
     │                   │                  │                  │
     ▼                   ▼                  ▼                  ▼
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│・メール    │     │・Redis保存 │     │・コード照合│     │・DB登録    │
│・パスワード│     │・メール送信│     │・有効期限  │     │・JWT発行   │
│・ニックネーム│    │            │     │  チェック  │     │・ログイン  │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
```

### 2.2 詳細フロー

```
[ユーザー]                    [フロントエンド]                    [バックエンド]                    [Redis]                    [メールサービス]
    │                              │                                   │                            │                              │
    │  1. 登録情報入力             │                                   │                            │                              │
    │ ─────────────────────────▶  │                                   │                            │                              │
    │                              │                                   │                            │                              │
    │                              │  2. POST /auth/register/send-code │                            │                              │
    │                              │ ─────────────────────────────────▶│                            │                              │
    │                              │                                   │                            │                              │
    │                              │                                   │  3. メール重複チェック      │                              │
    │                              │                                   │ ───────────────────────────│                              │
    │                              │                                   │                            │                              │
    │                              │                                   │  4. 6桁認証コード生成      │                              │
    │                              │                                   │ ───────────────────────────│                              │
    │                              │                                   │                            │                              │
    │                              │                                   │  5. 登録情報+コード保存    │                              │
    │                              │                                   │ ──────────────────────────▶│                              │
    │                              │                                   │                            │  (TTL: 10分)                 │
    │                              │                                   │                            │                              │
    │                              │                                   │  6. 認証コードメール送信   │                              │
    │                              │                                   │ ─────────────────────────────────────────────────────────▶│
    │                              │                                   │                            │                              │
    │                              │  7. 成功レスポンス                │                            │                              │
    │                              │ ◀─────────────────────────────────│                            │                              │
    │                              │                                   │                            │                              │
    │  8. 認証コード入力画面表示   │                                   │                            │                              │
    │ ◀───────────────────────────│                                   │                            │                              │
    │                              │                                   │                            │                              │
    │  9. 認証コード入力           │                                   │                            │                              │
    │ ─────────────────────────▶  │                                   │                            │                              │
    │                              │                                   │                            │                              │
    │                              │  10. POST /auth/register/verify   │                            │                              │
    │                              │ ─────────────────────────────────▶│                            │                              │
    │                              │                                   │                            │                              │
    │                              │                                   │  11. Redis照合             │                              │
    │                              │                                   │ ──────────────────────────▶│                              │
    │                              │                                   │                            │                              │
    │                              │                                   │  12. ユーザー作成          │                              │
    │                              │                                   │ ───────────────────────────│                              │
    │                              │                                   │                            │                              │
    │                              │                                   │  13. Redis削除             │                              │
    │                              │                                   │ ──────────────────────────▶│                              │
    │                              │                                   │                            │                              │
    │                              │  14. JWT + ユーザー情報           │                            │                              │
    │                              │ ◀─────────────────────────────────│                            │                              │
    │                              │                                   │                            │                              │
    │  15. ログイン完了・メイン画面│                                   │                            │                              │
    │ ◀───────────────────────────│                                   │                            │                              │
    │                              │                                   │                            │                              │
```

## 3. 画面設計

### 3.1 会員登録画面（情報入力）

#### レイアウト

```
┌─────────────────────────────────────┐
│             ← 戻る                  │
├─────────────────────────────────────┤
│                                     │
│         🕐 最後はいつ？              │
│                                     │
│         新規アカウント登録           │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  メールアドレス                      │
│  ┌─────────────────────────────┐   │
│  │ example@email.com           │   │
│  └─────────────────────────────┘   │
│                                     │
│  パスワード                         │
│  ┌─────────────────────────────┐   │
│  │ ••••••••               👁   │   │
│  └─────────────────────────────┘   │
│  ※8文字以上、英数字を含む           │
│                                     │
│  パスワード（確認）                  │
│  ┌─────────────────────────────┐   │
│  │ ••••••••               👁   │   │
│  └─────────────────────────────┘   │
│                                     │
│  ニックネーム                        │
│  ┌─────────────────────────────┐   │
│  │ Taro                        │   │
│  └─────────────────────────────┘   │
│  ※1〜10文字                         │
│                                     │
│  ┌─────────────────────────────┐   │
│  │         認証コードを送信      │   │
│  └─────────────────────────────┘   │
│                                     │
│  既にアカウントをお持ちですか？       │
│         ログインはこちら             │
│                                     │
└─────────────────────────────────────┘
```

#### 入力項目

| 項目名 | 入力形式 | 必須 | バリデーション |
|-------|---------|------|--------------|
| メールアドレス | email | ○ | RFC 5322準拠、255文字以内 |
| パスワード | password | ○ | 8文字以上、英字と数字を含む |
| パスワード（確認） | password | ○ | パスワードと一致 |
| ニックネーム | text | ○ | 1〜10文字 |

#### エラー表示

- 各入力フィールドの下にエラーメッセージを赤文字で表示
- 入力フォーカスが外れたタイミングでリアルタイムバリデーション
- 送信時に全項目を再バリデーション

### 3.2 認証コード入力画面

#### レイアウト

```
┌─────────────────────────────────────┐
│             ← 戻る                  │
├─────────────────────────────────────┤
│                                     │
│              ✉️                     │
│                                     │
│         認証コードを入力             │
│                                     │
│   user@example.com に                │
│   6桁の認証コードを送信しました       │
│                                     │
├─────────────────────────────────────┤
│                                     │
│     ┌───┬───┬───┬───┬───┬───┐      │
│     │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │      │
│     └───┴───┴───┴───┴───┴───┘      │
│                                     │
│         有効期限: 09:45             │
│                                     │
│  ┌─────────────────────────────┐   │
│  │           確認する           │   │
│  └─────────────────────────────┘   │
│                                     │
│   コードが届きませんか？             │
│         再送信する                  │
│                                     │
└─────────────────────────────────────┘
```

#### 機能

| 機能 | 説明 |
|-----|------|
| 認証コード入力 | 6桁の数字を1文字ずつ入力（自動フォーカス移動） |
| 有効期限表示 | 残り時間をカウントダウン表示（10分） |
| 再送信 | 認証コードの再送信（60秒間のクールダウン） |
| 自動送信 | 6桁入力完了時に自動的に検証APIを呼び出し |

#### エラー表示

| エラー | メッセージ |
|-------|----------|
| コード不一致 | 認証コードが正しくありません |
| 有効期限切れ | 認証コードの有効期限が切れました。再送信してください |
| 試行回数超過 | 試行回数が上限に達しました。しばらくしてからお試しください |

### 3.3 登録完了画面

#### レイアウト

```
┌─────────────────────────────────────┐
│                                     │
│              ✓                      │
│                                     │
│        登録が完了しました！          │
│                                     │
│   ようこそ、Taro さん               │
│                                     │
│  ┌─────────────────────────────┐   │
│  │        はじめる              │   │
│  └─────────────────────────────┘   │
│                                     │
└─────────────────────────────────────┘
```

## 4. API設計

### 4.1 認証コード送信 API

#### エンドポイント
```
POST /auth/register/send-code
```

#### 説明
会員登録に必要な情報を受け取り、認証コードをメールで送信する。
登録情報はRedisに一時保存される。

#### リクエスト

```typescript
interface SendCodeRequest {
  email: string;       // メールアドレス
  password: string;    // パスワード（8文字以上、英数字含む）
  nickname: string;    // ニックネーム（1〜10文字）
}
```

**リクエスト例:**
```json
POST /auth/register/send-code
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123",
  "nickname": "Taro"
}
```

#### レスポンス

**成功時（200 OK）:**
```json
{
  "success": true,
  "data": {
    "message": "認証コードを送信しました",
    "email": "user@example.com",
    "expiresIn": 600
  },
  "meta": {
    "timestamp": "2026-01-24T12:34:56Z"
  }
}
```

**エラー時（400 Bad Request - バリデーションエラー）:**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力内容に誤りがあります",
    "details": {
      "email": "有効なメールアドレスを入力してください",
      "password": "パスワードは8文字以上で、英字と数字を含めてください"
    }
  }
}
```

**エラー時（429 Too Many Requests - レート制限）:**
```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "送信回数の上限に達しました。しばらくしてからお試しください"
  }
}
```

### 4.2 認証コード検証・登録完了 API

#### エンドポイント
```
POST /auth/register/verify
```

#### 説明
認証コードを検証し、正しければユーザーを作成してJWTを発行する。

#### リクエスト

```typescript
interface VerifyCodeRequest {
  email: string;    // メールアドレス
  code: string;     // 6桁の認証コード
}
```

**リクエスト例:**
```json
POST /auth/register/verify
Content-Type: application/json

{
  "email": "user@example.com",
  "code": "123456"
}
```

#### レスポンス

**成功時（201 Created）:**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "nickname": "Taro",
      "createdAt": "2026-01-24T12:34:56Z"
    },
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  },
  "meta": {
    "timestamp": "2026-01-24T12:34:56Z"
  }
}
```

**エラー時（400 Bad Request - コード不一致）:**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_VERIFICATION_CODE",
    "message": "認証コードが正しくありません"
  }
}
```

**エラー時（400 Bad Request - 有効期限切れ）:**
```json
{
  "success": false,
  "error": {
    "code": "VERIFICATION_CODE_EXPIRED",
    "message": "認証コードの有効期限が切れました。再送信してください"
  }
}
```

**エラー時（429 Too Many Requests - 試行回数超過）:**
```json
{
  "success": false,
  "error": {
    "code": "TOO_MANY_ATTEMPTS",
    "message": "試行回数が上限に達しました。しばらくしてからお試しください"
  }
}
```

### 4.3 認証コード再送信 API

#### エンドポイント
```
POST /auth/register/resend-code
```

#### 説明
認証コードを再送信する。前回の送信から60秒以上経過している必要がある。

#### リクエスト

```typescript
interface ResendCodeRequest {
  email: string;    // メールアドレス
}
```

**リクエスト例:**
```json
POST /auth/register/resend-code
Content-Type: application/json

{
  "email": "user@example.com"
}
```

#### レスポンス

**成功時（200 OK）:**
```json
{
  "success": true,
  "data": {
    "message": "認証コードを再送信しました",
    "email": "user@example.com",
    "expiresIn": 600
  }
}
```

**エラー時（400 Bad Request - 登録情報なし）:**
```json
{
  "success": false,
  "error": {
    "code": "REGISTRATION_NOT_FOUND",
    "message": "登録情報が見つかりません。最初からやり直してください"
  }
}
```

**エラー時（429 Too Many Requests - クールダウン中）:**
```json
{
  "success": false,
  "error": {
    "code": "RESEND_COOLDOWN",
    "message": "再送信は60秒後に可能です",
    "details": {
      "retryAfter": 45
    }
  }
}
```

## 5. Redis データ設計

### 5.1 データ構造

#### 会員登録一時データ

**キー形式:**
```
registration:{email}
```

**値（JSON）:**
```typescript
interface RegistrationData {
  email: string;           // メールアドレス
  passwordHash: string;    // ハッシュ化済みパスワード
  nickname: string;        // ニックネーム
  code: string;            // 6桁認証コード（ハッシュ化）
  attempts: number;        // 認証試行回数
  lastSentAt: number;      // 最終送信日時（Unix timestamp）
  createdAt: number;       // 作成日時（Unix timestamp）
  isExistingUser: boolean; // 既存ユーザーフラグ（ユーザー列挙攻撃対策用）
}
```

**例（新規ユーザー）:**
```json
{
  "email": "user@example.com",
  "passwordHash": "$2y$12$xxxxx...",
  "nickname": "Taro",
  "code": "$2y$12$yyyyy...",
  "attempts": 0,
  "lastSentAt": 1737714896,
  "createdAt": 1737714896,
  "isExistingUser": false
}
```

**例（既存ユーザー - ダミーデータ）:**
```json
{
  "email": "existing@example.com",
  "passwordHash": "",
  "nickname": "",
  "code": "$2y$12$zzzzz...",
  "attempts": 0,
  "lastSentAt": 1737714896,
  "createdAt": 1737714896,
  "isExistingUser": true
}
```

**TTL:** 600秒（10分）

#### レート制限データ

**キー形式:**
```
rate_limit:registration:{ip_address}
rate_limit:registration:{email}
```

**値:** 送信回数（整数）

**TTL:** 3600秒（1時間）

### 5.2 Redis操作

#### 認証コード送信時

```php
// 1. レート制限チェック
$sendCount = Redis::get("rate_limit:registration:{$email}");
if ($sendCount >= 5) {
    throw new RateLimitExceededException();
}

// 2. メール重複チェック（DB）
$isExistingUser = User::where('email', $email)->exists();

// 3. 6桁コード生成（どちらのケースでも生成）
$code = sprintf('%06d', random_int(0, 999999));

if ($isExistingUser) {
    // 4a. 既存ユーザーの場合：ダミーデータをRedisに保存
    //     ※ 認証コード検証時のレスポンスを統一するため
    $data = [
        'email' => $email,
        'passwordHash' => '',  // 空（使用しない）
        'nickname' => '',      // 空（使用しない）
        'code' => Hash::make($code),
        'attempts' => 0,
        'lastSentAt' => time(),
        'createdAt' => time(),
        'isExistingUser' => true,  // 既存ユーザーフラグ
    ];
    Redis::setex("registration:{$email}", 600, json_encode($data));
    
    // 5a. 既存ユーザーには通知メールを送信（認証コードは送らない）
    Mail::to($email)->send(new RegistrationAttemptNotification());
} else {
    // 4b. 新規ユーザーの場合：正規の登録データを保存
    $data = [
        'email' => $email,
        'passwordHash' => Hash::make($password),
        'nickname' => $nickname,
        'code' => Hash::make($code),
        'attempts' => 0,
        'lastSentAt' => time(),
        'createdAt' => time(),
        'isExistingUser' => false,
    ];
    Redis::setex("registration:{$email}", 600, json_encode($data));

    // 5b. 認証コードメール送信
    Mail::to($email)->send(new VerificationCodeMail($code));
}

// 6. レート制限カウンター更新（どちらのケースでも更新）
Redis::incr("rate_limit:registration:{$email}");
Redis::expire("rate_limit:registration:{$email}", 3600);

// 7. 同一のレスポンスを返す（ユーザー列挙攻撃対策）
return response()->json([
    'success' => true,
    'data' => [
        'message' => '認証コードを送信しました',
        'email' => $email,
        'expiresIn' => 600,
    ],
]);
```

#### 認証コード検証時

```php
// 1. 登録データ取得
$data = Redis::get("registration:{$email}");
if (!$data) {
    // ※ REGISTRATION_NOT_FOUND ではなく INVALID_VERIFICATION_CODE を返す
    //   （ユーザー列挙攻撃対策：エラーの種類で判別されないようにする）
    throw new InvalidVerificationCodeException();
}
$registrationData = json_decode($data, true);

// 2. 試行回数チェック
if ($registrationData['attempts'] >= 5) {
    throw new TooManyAttemptsException();
}

// 3. コード検証
if (!Hash::check($code, $registrationData['code'])) {
    // 試行回数をインクリメント
    $registrationData['attempts']++;
    Redis::setex(
        "registration:{$email}",
        Redis::ttl("registration:{$email}"),
        json_encode($registrationData)
    );
    throw new InvalidVerificationCodeException();
}

// 4. 既存ユーザーフラグチェック
if ($registrationData['isExistingUser']) {
    // ※ 既存ユーザーの場合も同じエラーを返す
    //   （コードが正しくても「不正」と表示）
    //   ※ 既存ユーザーには通知メールで「既に登録済み」と伝えている
    Redis::del("registration:{$email}");
    throw new InvalidVerificationCodeException();
}

// 5. ユーザー作成（新規ユーザーのみ）
$user = User::create([
    'email' => $registrationData['email'],
    'password' => $registrationData['passwordHash'],
    'nickname' => $registrationData['nickname'],
]);

// 6. Redis削除
Redis::del("registration:{$email}");

// 7. JWT発行・レスポンス
$token = JWTAuth::fromUser($user);
return response()->json([
    'success' => true,
    'data' => [
        'user' => [...],
        'accessToken' => $token,
    ],
], 201);
```

> **セキュリティポイント**: 
> - 既存ユーザーの場合もRedisにダミーデータを保存することで、`REGISTRATION_NOT_FOUND` エラーが発生しない
> - 認証コードが正しくても `isExistingUser` フラグで判定し、既存ユーザーなら同じエラーを返す
> - 攻撃者はエラーレスポンスからメールアドレスの登録有無を判別できない

## 6. メール設計

### 6.1 認証コードメール

#### 件名
```
【最後はいつ？】会員登録の認証コード
```

#### 本文（テキスト）

```
最後はいつ？をご利用いただきありがとうございます。

会員登録を完了するには、以下の認証コードを入力してください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
認証コード: 123456
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

※ このコードは10分間有効です。
※ このメールに心当たりがない場合は、無視してください。

----
最後はいつ？ サポートチーム
https://example.com
```

#### 本文（HTML）

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>認証コード</title>
</head>
<body style="font-family: sans-serif; padding: 20px;">
  <div style="max-width: 600px; margin: 0 auto;">
    <h1 style="color: #3B82F6;">最後はいつ？</h1>
    <p>会員登録を完了するには、以下の認証コードを入力してください。</p>
    
    <div style="background: #F3F4F6; padding: 20px; text-align: center; margin: 20px 0; border-radius: 8px;">
      <span style="font-size: 32px; font-weight: bold; letter-spacing: 8px;">123456</span>
    </div>
    
    <p style="color: #6B7280; font-size: 14px;">
      ※ このコードは10分間有効です。<br>
      ※ このメールに心当たりがない場合は、無視してください。
    </p>
    
    <hr style="border: none; border-top: 1px solid #E5E7EB; margin: 20px 0;">
    
    <p style="color: #9CA3AF; font-size: 12px;">
      最後はいつ？ サポートチーム<br>
      <a href="https://example.com">https://example.com</a>
    </p>
  </div>
</body>
</html>
```

### 6.2 登録試行通知メール（既存ユーザー向け）

メールアドレスが既に登録済みの場合に、そのユーザーへ送信する通知メール。
これにより、第三者が自分のメールアドレスで登録を試みたことを知ることができる。

> **セキュリティ上の目的**: このメールを送信し、APIレスポンスは新規登録時と同一にすることで、
> 攻撃者がメールアドレスの登録有無を判別できないようにする（ユーザー列挙攻撃対策）。

#### 件名
```
【最後はいつ？】アカウント登録のお知らせ
```

#### 本文（テキスト）

```
最後はいつ？をご利用いただきありがとうございます。

あなたのメールアドレスを使用して、新規アカウントの登録が試みられました。

既にアカウントをお持ちの場合：
この操作に心当たりがない場合は、このメールを無視してください。
あなたのアカウントは安全です。

パスワードをお忘れの場合：
以下のリンクからパスワードをリセットできます。
https://example.com/reset-password

ご不明な点がございましたら、サポートまでお問い合わせください。

----
最後はいつ？ サポートチーム
https://example.com
```

#### 本文（HTML）

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>アカウント登録のお知らせ</title>
</head>
<body style="font-family: sans-serif; padding: 20px;">
  <div style="max-width: 600px; margin: 0 auto;">
    <h1 style="color: #3B82F6;">最後はいつ？</h1>
    
    <p>あなたのメールアドレスを使用して、新規アカウントの登録が試みられました。</p>
    
    <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 16px; margin: 20px 0;">
      <p style="margin: 0; color: #92400E;">
        <strong>既にアカウントをお持ちの場合：</strong><br>
        この操作に心当たりがない場合は、このメールを無視してください。<br>
        あなたのアカウントは安全です。
      </p>
    </div>
    
    <p><strong>パスワードをお忘れの場合：</strong></p>
    <p>
      <a href="https://example.com/reset-password" 
         style="display: inline-block; background: #3B82F6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">
        パスワードをリセット
      </a>
    </p>
    
    <p style="color: #6B7280; font-size: 14px;">
      ご不明な点がございましたら、サポートまでお問い合わせください。
    </p>
    
    <hr style="border: none; border-top: 1px solid #E5E7EB; margin: 20px 0;">
    
    <p style="color: #9CA3AF; font-size: 12px;">
      最後はいつ？ サポートチーム<br>
      <a href="https://example.com">https://example.com</a>
    </p>
  </div>
</body>
</html>
```

## 7. バリデーション

### 7.1 フロントエンドバリデーション

| 項目 | ルール | エラーメッセージ |
|-----|-------|----------------|
| メールアドレス | 必須 | メールアドレスを入力してください |
| メールアドレス | 形式 | 有効なメールアドレスを入力してください |
| パスワード | 必須 | パスワードを入力してください |
| パスワード | 8文字以上 | パスワードは8文字以上で入力してください |
| パスワード | 英数字含む | パスワードは英字と数字を含めてください |
| パスワード（確認） | 一致 | パスワードが一致しません |
| ニックネーム | 必須 | ニックネームを入力してください |
| ニックネーム | 1〜10文字 | ニックネームは1〜10文字で入力してください |
| 認証コード | 6桁数字 | 6桁の数字を入力してください |

### 7.2 バックエンドバリデーション

```php
// 認証コード送信API
$rules = [
    'email' => ['required', 'email:rfc', 'max:255'],
    'password' => [
        'required',
        'string',
        'min:8',
        'regex:/^(?=.*[A-Za-z])(?=.*\d).+$/'
    ],
    'nickname' => ['required', 'string', 'min:1', 'max:10'],
];

// 認証コード検証API
$rules = [
    'email' => ['required', 'email:rfc'],
    'code' => ['required', 'string', 'size:6', 'regex:/^\d{6}$/'],
];
```

## 8. セキュリティ

### 8.1 レート制限

| 対象 | 制限 | 期間 |
|-----|------|------|
| 認証コード送信（メールアドレス単位） | 5回 | 1時間 |
| 認証コード送信（IPアドレス単位） | 10回 | 1時間 |
| 認証コード検証（メールアドレス単位） | 5回 | 登録セッション内 |
| 再送信クールダウン | 1回 | 60秒 |

### 8.2 セキュリティ対策

| 対策 | 説明 |
|-----|------|
| パスワードハッシュ化 | bcrypt（コスト12） |
| 認証コードハッシュ化 | bcryptでハッシュ化して保存 |
| HTTPS必須 | 全通信をSSL/TLSで暗号化 |
| CSRFトークン | フォーム送信時に検証 |
| 入力サニタイズ | XSS対策 |
| SQLインジェクション対策 | プリペアドステートメント使用 |
| ユーザー列挙攻撃対策 | メール重複時も同一レスポンスを返却 |

### 8.3 ユーザー列挙攻撃（User Enumeration Attack）対策

#### 概要
ユーザー列挙攻撃とは、攻撃者がシステムのレスポンスの違いを利用して、
特定のメールアドレスがサービスに登録されているかどうかを判別する攻撃手法です。

#### 対策方針

1. **レスポンスの統一**
   - メールアドレスが登録済みでも、新規登録と同一のレスポンスを返す
   - 「認証コードを送信しました」というメッセージで統一

2. **処理時間の統一**
   - 登録済み・未登録どちらの場合もメール送信処理を行う
   - レスポンス時間の差異から判別されることを防止

3. **既存ユーザーへの通知**
   - 登録済みメールアドレスには「登録試行通知メール」を送信
   - ユーザー自身が不正な登録試行を認識できるようにする

#### 実装時の注意

```php
// ❌ NG例：メール重複時にエラーを返す
if (User::where('email', $email)->exists()) {
    return response()->json([
        'success' => false,
        'error' => ['code' => 'EMAIL_ALREADY_EXISTS']
    ], 409);
}

// ✅ OK例：メール重複有無に関わらず同一レスポンス
$existingUser = User::where('email', $email)->exists();

if ($existingUser) {
    // 既存ユーザーには通知メールを送信
    Mail::to($email)->send(new RegistrationAttemptNotification());
} else {
    // 新規ユーザーには認証コードメールを送信
    Mail::to($email)->send(new VerificationCodeMail($code));
}

// どちらの場合も同じレスポンス
return response()->json([
    'success' => true,
    'data' => ['message' => '認証コードを送信しました']
]);
```

### 8.4 認証コード設計

| 項目 | 値 |
|-----|-----|
| 形式 | 6桁の数字（000000〜999999） |
| 有効期限 | 10分 |
| 最大試行回数 | 5回 |
| 生成方法 | `random_int(0, 999999)` |
| 保存方法 | bcryptハッシュ化 |

## 9. エラーコード一覧

| コード | HTTPステータス | 説明 |
|-------|--------------|------|
| VALIDATION_ERROR | 400 | バリデーションエラー |
| INVALID_VERIFICATION_CODE | 400 | 認証コードが正しくない |
| VERIFICATION_CODE_EXPIRED | 400 | 認証コードの有効期限切れ |
| TOO_MANY_ATTEMPTS | 429 | 認証試行回数超過 |
| RATE_LIMIT_EXCEEDED | 429 | レート制限超過 |
| RESEND_COOLDOWN | 429 | 再送信クールダウン中 |

> **セキュリティ注意**: 以下のエラーは意図的に定義していません。
> - `EMAIL_ALREADY_EXISTS` - メールアドレス重複
> - `REGISTRATION_NOT_FOUND` - 登録情報なし
> 
> これらのエラーを返すと、攻撃者がレスポンスの違いからメールアドレスの登録有無を
> 判別できてしまいます（ユーザー列挙攻撃）。
> 代わりに `INVALID_VERIFICATION_CODE` を統一的に使用します。

## 10. 実装時の注意事項

### 10.1 Redis設定

```php
// config/database.php
'redis' => [
    'client' => env('REDIS_CLIENT', 'phpredis'),
    'default' => [
        'host' => env('REDIS_HOST', '127.0.0.1'),
        'password' => env('REDIS_PASSWORD', null),
        'port' => env('REDIS_PORT', 6379),
        'database' => env('REDIS_DB', 0),
    ],
],
```

### 10.2 環境変数

```env
# Redis
REDIS_HOST=redis
REDIS_PASSWORD=null
REDIS_PORT=6379
REDIS_DB=0

# メール
MAIL_MAILER=smtp
MAIL_HOST=mailhog
MAIL_PORT=1025
MAIL_FROM_ADDRESS=noreply@example.com
MAIL_FROM_NAME="最後はいつ？"

# 認証コード設定
VERIFICATION_CODE_TTL=600
VERIFICATION_CODE_MAX_ATTEMPTS=5
VERIFICATION_CODE_RESEND_COOLDOWN=60
```

### 10.3 テスト観点

| 観点 | テスト内容 |
|-----|----------|
| 正常系 | 会員登録フロー全体が正常に動作すること |
| バリデーション | 各入力項目のバリデーションが正しく動作すること |
| 重複チェック | 既存メールアドレスで登録できないこと |
| 認証コード | 正しいコードで登録完了すること |
| 認証コード | 誤ったコードでエラーになること |
| 有効期限 | 期限切れコードでエラーになること |
| レート制限 | 制限超過時にエラーになること |
| 再送信 | クールダウン期間中は再送信できないこと |
| セキュリティ | パスワードがハッシュ化されていること |
