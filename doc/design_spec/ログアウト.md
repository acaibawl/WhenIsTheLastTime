# ログアウト設計書

## 1. 概要

### 1.1 目的
「最後はいつ？ (When Is The Last Time)」アプリケーションにおけるログアウト機能の設計を定義する。

### 1.2 機能概要
- ユーザーのセッションを終了し、認証状態を解除する
- JWTトークンを無効化する
- フロントエンドのローカル状態をクリアする
- ログイン画面へリダイレクトする

### 1.3 セキュリティ方針
- サーバーサイドでJWTトークンをブラックリストに追加
- フロントエンドでトークンとユーザー情報を完全削除
- ログアウト後のページアクセス制御

## 2. ログアウトフロー

### 2.1 フロー図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ログアウトフロー                                 │
└─────────────────────────────────────────────────────────────────────────────┘

┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  STEP 1    │     │  STEP 2    │     │  STEP 3    │     │  STEP 4    │
│ ログアウト │ ──▶ │ トークン   │ ──▶ │ ローカル   │ ──▶ │ リダイレクト│
│  ボタン押下 │     │  無効化    │     │ データ削除 │     │            │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
     │                   │                  │                  │
     ▼                   ▼                  ▼                  ▼
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│・確認ダイア│     │・API呼び出し│     │・トークン  │     │・ログイン  │
│  ログ表示  │     │・ブラック  │     │  削除      │     │  画面へ    │
│・ユーザー  │     │  リスト追加│     │・ユーザー  │     │  遷移      │
│  確認      │     │            │     │  情報削除  │     │            │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
```

### 2.2 詳細フロー

```
[ユーザー]                    [フロントエンド]                    [バックエンド]
    │                              │                                   │
    │  1. ログアウトボタンタップ   │                                   │
    │ ─────────────────────────▶  │                                   │
    │                              │                                   │
    │  2. 確認ダイアログ表示       │                                   │
    │ ◀───────────────────────────│                                   │
    │                              │                                   │
    │  3. 「ログアウト」確認       │                                   │
    │ ─────────────────────────▶  │                                   │
    │                              │                                   │
    │                              │  4. ローディング表示              │
    │                              │ ───────────────────────────────── │
    │                              │                                   │
    │                              │  5. POST /auth/logout             │
    │                              │ ─────────────────────────────────▶│
    │                              │                                   │
    │                              │                                   │  6. JWTトークン
    │                              │                                   │     ブラックリスト追加
    │                              │                                   │ ─────────────────
    │                              │                                   │
    │                              │  7. 成功レスポンス (200)          │
    │                              │ ◀─────────────────────────────────│
    │                              │                                   │
    │                              │  8. ローカルストレージクリア      │
    │                              │ ───────────────────────────────── │
    │                              │                                   │
    │                              │  9. 認証状態リセット              │
    │                              │ ───────────────────────────────── │
    │                              │                                   │
    │  10. ログイン画面へ遷移      │                                   │
    │ ◀───────────────────────────│                                   │
    │                              │                                   │
```

### 2.3 エラーハンドリングフロー

```
[ユーザー]                    [フロントエンド]                    [バックエンド]
    │                              │                                   │
    │                              │  POST /auth/logout                │
    │                              │ ─────────────────────────────────▶│
    │                              │                                   │
    │                              │  エラーレスポンス (401/500等)     │
    │                              │ ◀─────────────────────────────────│
    │                              │                                   │
    │                              │  ※ エラー時もローカルデータは    │
    │                              │    クリアしてログイン画面へ遷移   │
    │                              │ ───────────────────────────────── │
    │                              │                                   │
    │  ログイン画面へ遷移          │                                   │
    │ ◀───────────────────────────│                                   │
    │                              │                                   │
```

**備考**: APIエラー時もフロントエンドのログアウト処理は続行する。
これはユーザー体験を損なわないためと、セキュリティ上の観点から、
ローカルに保存されたトークンは必ず削除する必要があるため。

## 3. 画面設計

### 3.1 ログアウトボタンの配置

ログアウトボタンは以下の画面に配置する：

#### 3.1.1 サイドメニュー

```
┌─────────────────────────────────────┐
│                                     │
│  最後はいつ？                        │
│  👤 Taro                            │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  時間でフィルター                    │
│  ...                                │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  カテゴリーでフィルター              │
│  ...                                │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  ⚙️  設定                            │
│                                     │
│  💬 問題/ご意見                      │
│                                     │
│  🚪 ログアウト                       │ ← ログアウトボタン
│                                     │
└─────────────────────────────────────┘
```

### 3.2 ログアウトボタン

#### スタイル仕様

| 項目 | 値 |
|-----|-----|
| アイコン | 🚪（ドアアイコン）または logout アイコン |
| テキスト | ログアウト |
| フォントサイズ | 16px |
| フォントウェイト | 500（Medium） |
| テキスト色 | #EF4444（警告色・赤） |
| 背景色 | 透明 |
| パディング | 16px（上下）、20px（左右） |
| ホバー時背景 | rgba(239, 68, 68, 0.1) |

#### 配置仕様

- サイドメニューの下部に配置
- 「設定」「問題/ご意見」の下に配置
- ボーダー上部で区切りを入れる（1px solid #E5E7EB）

### 3.3 確認ダイアログ

#### レイアウト

```
┌─────────────────────────────────────┐
│                                     │
│          ログアウトしますか？        │
│                                     │
│   ログアウトすると、再度ログインが   │
│   必要になります。                   │
│                                     │
│  ┌───────────┐  ┌───────────┐      │
│  │ キャンセル │  │ ログアウト │      │
│  └───────────┘  └───────────┘      │
│                                     │
└─────────────────────────────────────┘
```

#### ダイアログ仕様

| 項目 | 値 |
|-----|-----|
| 背景オーバーレイ | rgba(0, 0, 0, 0.5) |
| ダイアログ背景 | 白 (#FFFFFF) |
| ボーダーラジアス | 12px |
| パディング | 24px |
| 最大幅 | 320px |
| シャドウ | 0 4px 6px rgba(0, 0, 0, 0.1) |

#### タイトル

| 項目 | 値 |
|-----|-----|
| テキスト | ログアウトしますか？ |
| フォントサイズ | 18px |
| フォントウェイト | 600（Semi-Bold） |
| テキスト色 | #1F2937 |
| マージン下 | 12px |

#### 説明文

| 項目 | 値 |
|-----|-----|
| テキスト | ログアウトすると、再度ログインが必要になります。 |
| フォントサイズ | 14px |
| フォントウェイト | 400（Regular） |
| テキスト色 | #6B7280 |
| マージン下 | 24px |

#### ボタン

**キャンセルボタン:**

| 項目 | 値 |
|-----|-----|
| テキスト | キャンセル |
| 背景色 | #F3F4F6 |
| テキスト色 | #374151 |
| フォントサイズ | 14px |
| フォントウェイト | 500（Medium） |
| ボーダーラジアス | 8px |
| パディング | 12px 24px |
| 幅 | 50%（ボタンエリアの半分） |

**ログアウトボタン:**

| 項目 | 値 |
|-----|-----|
| テキスト | ログアウト |
| 背景色 | #EF4444 |
| テキスト色 | 白 (#FFFFFF) |
| フォントサイズ | 14px |
| フォントウェイト | 500（Medium） |
| ボーダーラジアス | 8px |
| パディング | 12px 24px |
| 幅 | 50%（ボタンエリアの半分） |

### 3.4 ローディング状態

ログアウト処理中は共通のローディングオーバーレイを表示する。

```
┌─────────────────────────────────────┐
│                                     │
│                                     │
│          ┌───────────┐              │
│          │           │              │
│          │   ⟳      │              │
│          │ ログアウト中...│          │
│          │           │              │
│          └───────────┘              │
│                                     │
│                                     │
└─────────────────────────────────────┘
```

※ 共通設計書のローディングオーバーレイ仕様に準拠

## 4. API設計

### 4.1 ログアウトAPI

#### エンドポイント
```
POST /auth/logout
```

#### 認証
必須（Bearer Token）

#### リクエスト

ヘッダーのみ（ボディなし）

```http
POST /auth/logout
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

#### レスポンス

**成功時（200 OK）:**

```json
{
  "success": true,
  "data": {
    "message": "ログアウトしました"
  },
  "meta": {
    "timestamp": "2026-01-25T12:34:56Z"
  }
}
```

**エラー時（401 Unauthorized）:**

```json
{
  "success": false,
  "error": {
    "code": "INVALID_TOKEN",
    "message": "認証トークンが無効です"
  },
  "meta": {
    "timestamp": "2026-01-25T12:34:56Z"
  }
}
```

**エラー時（500 Internal Server Error）:**

```json
{
  "success": false,
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "サーバーエラーが発生しました"
  },
  "meta": {
    "timestamp": "2026-01-25T12:34:56Z"
  }
}
```

### 4.2 バックエンド処理

#### 処理フロー

1. リクエストからJWTトークンを取得
2. トークンの有効性を検証
3. トークンをブラックリストに追加（tymon/jwt-auth の機能を使用）
4. 成功レスポンスを返却

#### 実装例

```php
public function logout(): JsonResponse
{
    /** @var JWTGuard $guard */
    $guard = auth()->guard('api');
    $guard->logout();

    return response()->json([
        'success' => true,
        'data' => [
            'message' => 'ログアウトしました'
        ],
        'meta' => [
            'timestamp' => now()->toISOString()
        ]
    ]);
}
```

### 4.3 トークン無効化

#### JWTブラックリスト

- tymon/jwt-auth パッケージのブラックリスト機能を使用
- `config/jwt.php` で `blacklist_enabled` を `true` に設定
- ログアウト時に `logout()` メソッドを呼び出すことで自動的にブラックリストに追加
- ブラックリストはキャッシュ（Redis推奨）に保存

#### 設定例

```php
// config/jwt.php
'blacklist_enabled' => env('JWT_BLACKLIST_ENABLED', true),
'blacklist_grace_period' => env('JWT_BLACKLIST_GRACE_PERIOD', 0),
```

## 5. フロントエンド実装

### 5.1 ログアウト処理

#### 処理フロー

1. 確認ダイアログを表示
2. ユーザーが「ログアウト」を選択
3. ローディングオーバーレイを表示
4. ログアウトAPIを呼び出し
5. ローカルストレージからトークンを削除
6. 認証状態（Pinia/Vuex）をリセット
7. ログイン画面へリダイレクト

#### 実装例（Composable）

```typescript
// composables/useAuth.ts
export const useAuth = () => {
  const router = useRouter();
  const authStore = useAuthStore();

  const logout = async (): Promise<void> => {
    try {
      // APIを呼び出し（エラーが発生しても続行）
      await $fetch('/auth/logout', {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${authStore.accessToken}`
        }
      }).catch(() => {
        // エラーを無視して処理を続行
        console.warn('Logout API failed, but continuing with local cleanup');
      });
    } finally {
      // ローカルのクリーンアップは必ず実行
      clearLocalAuth();
      router.push('/login');
    }
  };

  const clearLocalAuth = (): void => {
    // ローカルストレージをクリア
    localStorage.removeItem('access_token');
    localStorage.removeItem('user');
    
    // 認証状態をリセット
    authStore.$reset();
  };

  return {
    logout,
    clearLocalAuth
  };
};
```

### 5.2 確認ダイアログ

#### 実装例（コンポーネント）

```vue
<!-- components/LogoutConfirmDialog.vue -->
<template>
  <div v-if="isOpen" class="dialog-overlay" @click.self="close">
    <div class="dialog-content">
      <h2 class="dialog-title">ログアウトしますか？</h2>
      <p class="dialog-message">
        ログアウトすると、再度ログインが必要になります。
      </p>
      <div class="dialog-actions">
        <button class="btn-cancel" @click="close">
          キャンセル
        </button>
        <button class="btn-logout" @click="confirmLogout">
          ログアウト
        </button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
interface Props {
  isOpen: boolean;
}

interface Emits {
  (e: 'close'): void;
  (e: 'confirm'): void;
}

defineProps<Props>();
const emit = defineEmits<Emits>();

const close = () => emit('close');
const confirmLogout = () => emit('confirm');
</script>
```

### 5.3 状態管理

#### 認証ストア

```typescript
// stores/auth.ts
import { defineStore } from 'pinia';

interface AuthState {
  accessToken: string | null;
  user: User | null;
  isAuthenticated: boolean;
}

export const useAuthStore = defineStore('auth', {
  state: (): AuthState => ({
    accessToken: null,
    user: null,
    isAuthenticated: false
  }),

  actions: {
    setAuth(token: string, user: User) {
      this.accessToken = token;
      this.user = user;
      this.isAuthenticated = true;
      localStorage.setItem('access_token', token);
      localStorage.setItem('user', JSON.stringify(user));
    },

    $reset() {
      this.accessToken = null;
      this.user = null;
      this.isAuthenticated = false;
    }
  }
});
```

## 6. ルーティング・ナビゲーション

### 6.1 ログアウト後の遷移先

| 遷移元 | 遷移先 | 備考 |
|-------|-------|------|
| 任意の画面 | /login | ログイン画面 |

### 6.2 認証ガード

ログアウト後、認証が必要なページにアクセスした場合は自動的にログイン画面へリダイレクトする。

#### 実装例（Middleware）

```typescript
// middleware/auth.ts
export default defineNuxtRouteMiddleware((to) => {
  const authStore = useAuthStore();

  // 認証不要なページ
  const publicPages = ['/login', '/register', '/forgot-password'];
  
  if (publicPages.includes(to.path)) {
    return;
  }

  // 未認証の場合はログイン画面へ
  if (!authStore.isAuthenticated) {
    return navigateTo('/login');
  }
});
```

## 7. エラーハンドリング

### 7.1 エラーケース

| エラー | 原因 | 対応 |
|-------|------|------|
| 401 Unauthorized | トークンが無効または期限切れ | ローカルデータをクリアしてログイン画面へ遷移 |
| 500 Internal Server Error | サーバーエラー | ローカルデータをクリアしてログイン画面へ遷移（エラーログ記録） |
| Network Error | ネットワーク接続なし | ローカルデータをクリアしてログイン画面へ遷移 |

### 7.2 エラー処理方針

1. **APIエラー時もログアウト処理は続行**
   - サーバー側でトークンが無効化されなくても、フロントエンドではログアウト状態にする
   - セキュリティ上、ローカルのトークンは必ず削除する

2. **エラーメッセージは表示しない**
   - ログアウト時のエラーはユーザーに通知する必要がない
   - コンソールにエラーログを記録し、ログアウト処理を続行

## 8. セキュリティ考慮事項

### 8.1 トークン管理

| 項目 | 対策 |
|------|------|
| トークン保存 | HttpOnly Cookie または localStorage |
| トークン無効化 | サーバー側でブラックリストに追加 |
| トークン漏洩時 | すべてのトークンを無効化可能（緊急対応） |

### 8.2 セッション管理

| 項目 | 値 |
|------|-----|
| トークン有効期限 | 7日間（config/jwt.php で設定） |
| ブラックリスト有効期限 | トークンの有効期限と同じ |
| 同時ログイン | 許可（複数デバイスでログイン可能） |

### 8.3 ログアウト時のクリーンアップ

以下のデータをクリアする：

1. **ローカルストレージ**
   - `access_token`
   - `user`
   - その他認証関連データ

2. **セッションストレージ**
   - 一時的な認証データ

3. **アプリケーション状態**
   - Pinia/Vuex の認証ストア
   - メモリ上のユーザー情報

## 9. テスト仕様

### 9.1 ユニットテスト

#### バックエンド

| テストケース | 期待結果 |
|-------------|---------|
| 有効なトークンでログアウト | 200 OK、トークンがブラックリストに追加 |
| 無効なトークンでログアウト | 401 Unauthorized |
| トークンなしでログアウト | 401 Unauthorized |
| ブラックリスト済みトークンでログアウト | 401 Unauthorized |

#### フロントエンド

| テストケース | 期待結果 |
|-------------|---------|
| ログアウトボタンクリック | 確認ダイアログが表示される |
| 確認ダイアログでキャンセル | ダイアログが閉じ、状態は変わらない |
| 確認ダイアログでログアウト | API呼び出し、ローカルクリア、リダイレクト |
| APIエラー時 | ローカルクリア、リダイレクト（エラー表示なし） |

### 9.2 E2Eテスト

| テストケース | 手順 | 期待結果 |
|-------------|------|---------|
| 正常ログアウト | 1. ログイン<br>2. サイドメニュー開く<br>3. ログアウトボタンタップ<br>4. 確認で「ログアウト」選択 | ログイン画面に遷移 |
| ログアウトキャンセル | 1. ログイン<br>2. サイドメニュー開く<br>3. ログアウトボタンタップ<br>4. 確認で「キャンセル」選択 | ダイアログが閉じ、ログイン状態維持 |
| ログアウト後のアクセス制御 | 1. ログアウト<br>2. メイン画面にアクセス | ログイン画面にリダイレクト |

## 10. 今後の拡張

### 10.1 Phase 2以降の検討事項

| 機能 | 説明 | 優先度 |
|------|------|-------|
| 全デバイスからログアウト | すべてのセッションを一括無効化 | 中 |
| ログアウト履歴 | ログアウト日時・デバイス情報の記録 | 低 |
| 自動ログアウト | 一定時間操作がない場合の自動ログアウト | 中 |
| ログアウト通知 | 他のデバイスからログアウトされた場合の通知 | 低 |
