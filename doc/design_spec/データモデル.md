# データモデル設計書

## 1. 概要

### 1.1 目的
「最後はいつ？ (When Is The Last Time)」アプリケーションのデータベース設計を定義する。

### 1.2 データベース
- **RDBMS**: MySQL 8.0以上
- **文字コード**: UTF-8 (utf8mb4)
- **照合順序**: utf8mb4_unicode_ci
- **タイムゾーン**: UTC（アプリケーション側で変換）

### 1.3 命名規則
- **テーブル名**: スネークケース、複数形（例: `events`, `histories`）
- **カラム名**: スネークケース（例: `created_at`, `user_id`）
- **インデックス名**: `idx_テーブル名_カラム名`（例: `idx_events_user_id`）
- **外部キー名**: `fk_テーブル名_参照テーブル名`（例: `fk_histories_events`）

## 2. ER図

```
┌─────────────────┐
│     users       │
├─────────────────┤
│ id (PK)        │
│ email          │
│ password_hash  │
│ nickname       │
│ created_at     │
│ updated_at     │
└────────┬────────┘
         │ 1
         │
         │ N
┌────────┴────────┐
│     events      │
├─────────────────┤
│ id (PK)        │
│ user_id (FK)   │
│ name           │
│ category_icon  │
│ last_executed_history_id (FK)│
│ created_at     │
│ updated_at     │
└────────┬────────┘
         │ 1
         │
         │ N
┌────────┴────────┐
│   histories     │
├─────────────────┤
│ id (PK)        │
│ event_id (FK)  │
│ executed_at    │
│ memo           │
│ created_at     │
│ updated_at     │
└─────────────────┘

┌─────────────────┐
│  user_settings  │
├─────────────────┤
│ id (PK)        │
│ user_id (FK)   │
│ settings_json  │
│ created_at     │
│ updated_at     │
└─────────────────┘
```

## 3. テーブル定義

### 3.1 users テーブル

ユーザー情報を管理するテーブル。

```sql
CREATE TABLE users (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ユーザーID',
  email VARCHAR(255) NOT NULL COMMENT 'メールアドレス',
  password_hash VARCHAR(255) NOT NULL COMMENT 'パスワードハッシュ',
  nickname VARCHAR(10) NOT NULL COMMENT 'ニックネーム',
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
  PRIMARY KEY (id),
  UNIQUE KEY uk_users_email (email),
  INDEX idx_users_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ユーザー';
```

#### カラム詳細

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | BIGINT UNSIGNED | NO | AUTO_INCREMENT | ユーザーID（主キー） |
| email | VARCHAR(255) | NO | - | メールアドレス（ログイン用） |
| password_hash | VARCHAR(255) | NO | - | bcryptでハッシュ化されたパスワード |
| nickname | VARCHAR(50) | NO | - | ニックネーム（画面表示用） |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード更新日時 |

#### インデックス

| インデックス名 | 種類 | カラム | 説明 |
|--------------|------|--------|------|
| PRIMARY | PRIMARY KEY | id | 主キー |
| uk_users_email | UNIQUE | email | メールアドレスの一意性保証 |
| idx_users_created_at | INDEX | created_at | 作成日時での検索用 |

#### バリデーション

- **email**: RFC 5322準拠のメールアドレス形式
- **password_hash**: bcrypt形式（$2a$, $2b$, $2y$のいずれか）
- **nickname**: 1～10文字、空白のみ不可

### 3.2 events テーブル

イベント情報を管理するテーブル。

```sql
CREATE TABLE events (
  id VARCHAR(50) NOT NULL COMMENT 'イベントID（evt_プレフィックス）',
  user_id BIGINT UNSIGNED NOT NULL COMMENT 'ユーザーID',
  name VARCHAR(100) NOT NULL COMMENT 'イベント名',
  category_icon VARCHAR(20) NOT NULL COMMENT 'カテゴリーアイコン',
  last_executed_history_id VARCHAR(50) COMMENT '最終実行履歴ID（履歴の中で最新のもの）',
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
  PRIMARY KEY (id),
  INDEX idx_events_user_id (user_id),
  INDEX idx_events_category_icon (category_icon),
  INDEX idx_events_created_at (created_at),
  CONSTRAINT fk_events_users FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
  -- 注意: last_executed_history_id の外部キーは履歴テーブル作成後に追加
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='イベント';
```

#### カラム詳細

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | VARCHAR(50) | NO | - | イベントID（主キー）<br>形式: `evt_` + ユニークID |
| user_id | BIGINT UNSIGNED | NO | - | ユーザーID（外部キー） |
| name | VARCHAR(100) | NO | - | イベント名（例: "エアコンフィルター掃除"） |
| category_icon | VARCHAR(20) | NO | - | カテゴリーアイコン識別子 |
| last_executed_history_id | VARCHAR(50) | YES | NULL | 最終実行履歴ID（外部キー）<br>履歴の中で最新のものを参照 |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード更新日時 |

#### カテゴリーアイコン一覧

| 識別子 | 表示アイコン | 説明 |
|-------|------------|------|
| pin | 📌 | ピン |
| book | 📚 | 本・読書 |
| folder | 📁 | フォルダ |
| star | ⭐ | スター |
| chart | 📊 | グラフ |
| sun | ☀️ | 太陽・天気 |
| person | 👤 | 人物 |
| hospital | 🏥 | 病院・医療 |
| medical | ➕ | プラス・医療 |
| leaf | 🍃 | 葉っぱ |
| search | 🔍 | 虫眼鏡 |
| people | 👥 | 複数人 |
| snowflake | ❄️ | 雪の結晶 |
| fire | 🔥 | 炎 |
| lightning | ⚡ | 雷 |

#### インデックス

| インデックス名 | 種類 | カラム | 説明 |
|--------------|------|--------|------|
| PRIMARY | PRIMARY KEY | id | 主キー |
| idx_events_user_id | INDEX | user_id | ユーザーごとのイベント取得 |
| idx_events_category_icon | INDEX | category_icon | カテゴリーフィルタリング |
| idx_events_created_at | INDEX | created_at | 作成日時でのソート |
| fk_events_users | FOREIGN KEY | user_id | ユーザーとの関連付け |
| fk_events_histories | FOREIGN KEY | last_executed_history_id | 最新履歴との関連付け |

#### バリデーション

- **id**: `evt_` で始まる50文字以内の文字列
- **name**: 1〜100文字
- **category_icon**: 上記カテゴリーアイコン一覧のいずれか
- **last_executed_history_id**: 存在する履歴IDまたはNULL

#### 外部キー追加（履歴テーブル作成後）

```sql
ALTER TABLE events
ADD CONSTRAINT fk_events_histories 
FOREIGN KEY (last_executed_history_id) REFERENCES histories(id) ON DELETE SET NULL;
```

### 3.3 histories テーブル

イベントの実行履歴を管理するテーブル。

```sql
CREATE TABLE histories (
  id VARCHAR(50) NOT NULL COMMENT '履歴ID（hist_プレフィックス）',
  event_id VARCHAR(50) NOT NULL COMMENT 'イベントID',
  executed_at TIMESTAMP NOT NULL COMMENT '実行日時',
  memo TEXT COMMENT 'メモ（任意）',
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
  PRIMARY KEY (id),
  INDEX idx_histories_event_id (event_id),
  INDEX idx_histories_executed_at (executed_at),
  INDEX idx_histories_event_id_executed_at (event_id, executed_at),
  CONSTRAINT fk_histories_events FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='イベント実行履歴';
```

#### カラム詳細

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | VARCHAR(50) | NO | - | 履歴ID（主キー）<br>形式: `hist_` + ユニークID |
| event_id | VARCHAR(50) | NO | - | イベントID（外部キー） |
| executed_at | TIMESTAMP | NO | - | 実行日時 |
| memo | TEXT | YES | NULL | メモ（最大500文字を推奨） |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード更新日時 |

#### インデックス

| インデックス名 | 種類 | カラム | 説明 |
|--------------|------|--------|------|
| PRIMARY | PRIMARY KEY | id | 主キー |
| idx_histories_event_id | INDEX | event_id | イベントごとの履歴取得 |
| idx_histories_executed_at | INDEX | executed_at | 実行日時でのソート |
| idx_histories_event_id_executed_at | INDEX | event_id, executed_at | イベント内での日時ソート（複合） |
| fk_histories_events | FOREIGN KEY | event_id | イベントとの関連付け |

#### バリデーション

- **id**: `hist_` で始まる50文字以内の文字列
- **event_id**: 存在するイベントのID
- **executed_at**: 有効なタイムスタンプ
- **memo**: 500文字以内を推奨（TEXT型なので技術的には65,535文字まで可能）

### 3.4 user_settings テーブル

ユーザーごとの設定情報を管理するテーブル（サーバー管理の設定のみ）。

```sql
CREATE TABLE user_settings (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '設定ID',
  user_id BIGINT UNSIGNED NOT NULL COMMENT 'ユーザーID',
  settings_json JSON NOT NULL COMMENT '設定データ（JSON形式）',
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
  PRIMARY KEY (id),
  UNIQUE KEY uk_user_settings_user_id (user_id),
  CONSTRAINT fk_user_settings_users FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ユーザー設定';
```

#### カラム詳細

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | BIGINT UNSIGNED | NO | AUTO_INCREMENT | 設定ID（主キー） |
| user_id | BIGINT UNSIGNED | NO | - | ユーザーID（外部キー） |
| settings_json | JSON | NO | - | 設定データ（JSON形式） |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | レコード更新日時 |

#### settings_json の構造

```json
{
  "export": {
    "lastExportedAt": "2026-01-15T10:00:00Z"
  },
  "notification": {
    "reminder": {
      "enabled": false,
      "timing": {
        "type": "daily",
        "time": "09:00",
        "dayOfWeek": null,
        "dayOfMonth": null
      },
      "targetEvents": "week"
    }
  },
  "misc": {
    "showTutorial": false
  }
}
```

**注意:** ソート順、時間設定、タイムフリッパーはローカルストレージで管理するため、このテーブルには含まれません。

#### インデックス

| インデックス名 | 種類 | カラム | 説明 |
|--------------|------|--------|------|
| PRIMARY | PRIMARY KEY | id | 主キー |
| uk_user_settings_user_id | UNIQUE | user_id | ユーザーごとに1レコードのみ |
| fk_user_settings_users | FOREIGN KEY | user_id | ユーザーとの関連付け |

#### バリデーション

- **user_id**: 存在するユーザーのID
- **settings_json**: 有効なJSON形式

## 4. リレーション

### 4.1 users → events（1:N）
- 1人のユーザーは複数のイベントを持つ
- イベントは必ず1人のユーザーに属する
- ユーザー削除時、関連するすべてのイベントも削除される（CASCADE）

### 4.2 events → histories（1:N）
- 1つのイベントは複数の履歴を持つ
- 履歴は必ず1つのイベントに属する
- イベント削除時、関連するすべての履歴も削除される（CASCADE）

### 4.3 users → user_settings（1:1）
- 1人のユーザーは1つの設定レコードを持つ
- 設定レコードは必ず1人のユーザーに属する
- ユーザー削除時、関連する設定レコードも削除される（CASCADE）

## 5. インデックス戦略

### 5.1 主要なクエリパターン

#### パターン1: ユーザーの全イベント取得
```sql
SELECT e.*, h.executed_at as last_executed_at, h.memo as last_executed_memo
FROM events e
LEFT JOIN histories h ON e.last_executed_history_id = h.id
WHERE e.user_id = ? 
ORDER BY h.executed_at DESC;
```
- 使用インデックス: `idx_events_user_id`, `fk_events_histories`

#### パターン2: カテゴリーフィルタリング
```sql
SELECT e.*, h.executed_at as last_executed_at, h.memo as last_executed_memo
FROM events e
LEFT JOIN histories h ON e.last_executed_history_id = h.id
WHERE e.user_id = ? AND e.category_icon IN (?, ?, ?)
ORDER BY h.executed_at DESC;
```
- 使用インデックス: `idx_events_user_id`, `idx_events_category_icon`

#### パターン3: イベントの履歴取得
```sql
SELECT * FROM histories 
WHERE event_id = ? 
ORDER BY executed_at DESC;
```
- 使用インデックス: `idx_histories_event_id_executed_at`（複合インデックス）

#### パターン4: 最新の履歴取得
```sql
SELECT * FROM histories 
WHERE event_id = ? 
ORDER BY executed_at DESC 
LIMIT 1;
```
- 使用インデックス: `idx_histories_event_id_executed_at`（複合インデックス）

### 5.2 パフォーマンス最適化

#### パーティショニング（Phase 2以降）
データ量が増加した場合、`executed_at` によるパーティショニングを検討：

```sql
-- 年単位でパーティショニング
ALTER TABLE histories PARTITION BY RANGE (YEAR(executed_at)) (
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION p2026 VALUES LESS THAN (2027),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

## 6. データ整合性

### 6.1 外部キー制約

すべての外部キーに `ON DELETE CASCADE` を設定：
- ユーザー削除 → 関連するすべてのイベント、設定が削除
- イベント削除 → 関連するすべての履歴が削除

### 6.2 last_executed_history_id の整合性管理

履歴が追加・更新・削除された際の `events.last_executed_history_id` の更新は、アプリケーション側のロジックで管理する。

- **履歴追加時**: 追加された履歴の `executed_at` が現在の最新履歴より新しい場合に `last_executed_history_id` を更新
- **履歴更新時**: 該当イベントの全履歴から最新の `executed_at` を持つ履歴IDを再計算して更新
- **履歴削除時**: 該当イベントの残りの履歴から最新の `executed_at` を持つ履歴IDを再計算して更新（履歴がない場合は NULL に設定）

### 6.3 トランザクション管理

#### イベント作成
```sql
START TRANSACTION;

-- イベント作成（初回はlast_executed_history_idはNULL）
INSERT INTO events (id, user_id, name, category_icon, last_executed_history_id) 
VALUES (?, ?, ?, ?, NULL);

-- 初回の履歴作成
INSERT INTO histories (id, event_id, executed_at, memo) 
VALUES (?, ?, ?, ?);

-- last_executed_history_id を更新
UPDATE events SET last_executed_history_id = ? WHERE id = ?;

COMMIT;
```

#### イベント削除
```sql
START TRANSACTION;

-- 履歴削除（CASCADE により自動）
-- イベント削除
DELETE FROM events WHERE id = ? AND user_id = ?;

COMMIT;
```

## 7. セキュリティ

### 7.1 アクセス制御

#### アプリケーション用ユーザー
```sql
CREATE USER 'app_user'@'%' IDENTIFIED BY 'secure_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON when_is_the_last_time.* TO 'app_user'@'%';
FLUSH PRIVILEGES;
```

#### 読み取り専用ユーザー（分析・バックアップ用）
```sql
CREATE USER 'readonly_user'@'%' IDENTIFIED BY 'readonly_password';
GRANT SELECT ON when_is_the_last_time.* TO 'readonly_user'@'%';
FLUSH PRIVILEGES;
```

### 7.2 機密情報の保護

- **パスワード**: bcryptでハッシュ化（コスト係数: 10以上）
- **個人情報**: 必要最小限のみ保存
- **通信**: SSL/TLS暗号化

### 7.3 SQLインジェクション対策

- プリペアドステートメントの使用
- ユーザー入力の検証・サニタイズ
- ORMの活用（TypeORM、Prismaなど）

## 8. バックアップ・リストア

### 8.1 バックアップ戦略

#### フルバックアップ（毎日）
```bash
mysqldump -u backup_user -p \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  when_is_the_last_time > backup_$(date +%Y%m%d).sql
```

#### 増分バックアップ（1時間ごと）
```bash
# バイナリログを有効化
# my.cnf に以下を追加:
# log_bin = /var/log/mysql/mysql-bin.log
# expire_logs_days = 7
# max_binlog_size = 100M
```

### 8.2 リストア手順

```bash
# フルリストア
mysql -u root -p when_is_the_last_time < backup_20260116.sql

# ポイントインタイムリカバリ
mysqlbinlog mysql-bin.000001 | mysql -u root -p when_is_the_last_time
```

## 9. データ移行

### 9.1 初期データ

#### ユーザー（テスト用）
```sql
INSERT INTO users (id, email, password_hash, nickname) VALUES
(1, 'test@example.com', '$2b$10$...', 'テストユーザー');
```

#### カテゴリーアイコンマスター（アプリケーション側で定義）
アプリケーションコード内で定義し、DBには保存しない。

### 9.2 マイグレーション

#### マイグレーションツール
- **推奨**: Flyway, Liquibase, TypeORM Migrations, Prisma Migrate
- **バージョン管理**: Gitでマイグレーションファイルを管理

#### マイグレーション例（Flyway形式）
```sql
-- V1__create_users_table.sql
CREATE TABLE users (...);

-- V2__create_events_table.sql
CREATE TABLE events (...);

-- V3__create_histories_table.sql
CREATE TABLE histories (...);

-- V4__create_user_settings_table.sql
CREATE TABLE user_settings (...);

-- V5__add_triggers.sql
CREATE TRIGGER trg_histories_after_insert_update (...);
```

## 10. モニタリング

### 10.1 監視項目

- **スロークエリログ**: 1秒以上かかるクエリを記録
- **テーブルサイズ**: 各テーブルの容量増加を監視
- **インデックス使用率**: 未使用インデックスの検出
- **レプリケーション遅延**: マスタースレーブ構成の場合

### 10.2 スロークエリログ設定

```sql
-- my.cnf に追加
slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 1
log_queries_not_using_indexes = 1
```

### 10.3 テーブルサイズ確認

```sql
SELECT 
  table_name,
  ROUND(((data_length + index_length) / 1024 / 1024), 2) AS "Size (MB)"
FROM information_schema.TABLES 
WHERE table_schema = "when_is_the_last_time"
ORDER BY (data_length + index_length) DESC;
```

## 11. 見積もり

### 11.1 データ容量見積もり

#### 前提条件
- ユーザー数: 10,000人
- 1ユーザーあたりのイベント数: 平均20個
- 1イベントあたりの履歴数: 平均50個

#### 計算

**users テーブル:**
- 1レコード: 約300バイト
- 10,000レコード: 約3 MB

**events テーブル:**
- 1レコード: 約500バイト
- 200,000レコード（10,000 × 20）: 約100 MB

**histories テーブル:**
- 1レコード: 約400バイト
- 10,000,000レコード（200,000 × 50）: 約4 GB

**user_settings テーブル:**
- 1レコード: 約500バイト
- 10,000レコード: 約5 MB

**合計: 約4.1 GB**

#### インデックス容量
インデックスはデータ容量の30〜50%程度: 約1.2〜2.0 GB

**総容量見積もり: 約6 GB**

### 11.2 パフォーマンス目標

- **イベント一覧取得**: 100ms以内
- **履歴一覧取得**: 50ms以内
- **イベント作成**: 200ms以内
- **履歴追加**: 100ms以内

## 12. 今後の拡張性

### Phase 2以降で追加予定

#### 12.1 イベント共有機能
```sql
CREATE TABLE event_shares (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  event_id VARCHAR(50) NOT NULL,
  shared_with_user_id BIGINT UNSIGNED NOT NULL,
  permission ENUM('view', 'edit') NOT NULL DEFAULT 'view',
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE,
  FOREIGN KEY (shared_with_user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 12.2 リマインダー履歴
```sql
CREATE TABLE reminder_logs (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL,
  event_id VARCHAR(50) NOT NULL,
  sent_at TIMESTAMP NOT NULL,
  status ENUM('sent', 'failed') NOT NULL,
  PRIMARY KEY (id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE
);
```

#### 12.3 添付ファイル（写真）
```sql
CREATE TABLE attachments (
  id VARCHAR(50) NOT NULL,
  history_id VARCHAR(50) NOT NULL,
  file_url VARCHAR(500) NOT NULL,
  file_type VARCHAR(50) NOT NULL,
  file_size INT UNSIGNED NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  FOREIGN KEY (history_id) REFERENCES histories(id) ON DELETE CASCADE
);
```

#### 12.4 タグ機能
```sql
CREATE TABLE tags (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL,
  name VARCHAR(50) NOT NULL,
  color VARCHAR(7) NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE event_tags (
  event_id VARCHAR(50) NOT NULL,
  tag_id BIGINT UNSIGNED NOT NULL,
  PRIMARY KEY (event_id, tag_id),
  FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);
```

## 13. TypeScript型定義

アプリケーション側で使用する型定義（参考）：

```typescript
// ユーザー
interface User {
  id: number;
  email: string;
  nickname: string;
  createdAt: string;
  updatedAt: string;
}

// イベント（DBモデル）
interface Event {
  id: string;
  userId: number;
  name: string;
  categoryIcon: CategoryIcon;
  lastExecutedHistoryId: string | null;
  createdAt: string;
  updatedAt: string;
}

// イベント（APIレスポンス用、履歴情報を含む）
interface EventWithLastExecuted {
  id: string;
  userId: number;
  name: string;
  categoryIcon: CategoryIcon;
  lastExecutedHistoryId: string | null;
  lastExecutedAt: string | null;     // 履歴から取得
  lastExecutedMemo: string | null;   // 履歴から取得
  createdAt: string;
  updatedAt: string;
}

// カテゴリーアイコン
type CategoryIcon = 
  | 'pin' | 'book' | 'folder' | 'star' | 'chart'
  | 'sun' | 'person' | 'hospital' | 'medical' | 'leaf'
  | 'search' | 'people' | 'snowflake' | 'fire' | 'lightning';

// 履歴
interface History {
  id: string;
  eventId: string;
  executedAt: string;
  memo: string | null;
  createdAt: string;
  updatedAt: string;
}

// ユーザー設定
interface UserSettings {
  id: number;
  userId: number;
  settingsJson: {
    export: {
      lastExportedAt?: string;
    };
    notification: {
      reminder: {
        enabled: boolean;
        timing: {
          type: 'daily' | 'weekly' | 'monthly';
          time: string;
          dayOfWeek?: number;
          dayOfMonth?: number;
        };
        targetEvents: 'all' | 'week' | 'month' | 'year';
      };
    };
    misc: {
      showTutorial: boolean;
    };
  };
  createdAt: string;
  updatedAt: string;
}
```

---

**作成日**: 2026/01/16  
**バージョン**: 1.0  
**更新履歴**:
- 2026/01/16: 初版作成
